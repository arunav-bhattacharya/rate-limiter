<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slot Assignment Service - Animated Presentation</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* ===== RESET & BASE ===== */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: #0a0e1a;
            color: #e8eaf6;
            line-height: 1.6;
        }

        /* ===== CSS VARIABLES ===== */
        :root {
            --bg: #0a0e1a;
            --bg2: #131a2e;
            --primary: #4a9eff;
            --success: #2ecc71;
            --warning: #f39c12;
            --error: #e74c3c;
            --text: #e8eaf6;
            --text-muted: #8892b0;
            --surface: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --code-bg: #1a1e2e;
            --mono: 'JetBrains Mono', 'Fira Code', monospace;
        }

        /* ===== PROGRESS BAR ===== */
        #progress-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 4px;
            background: rgba(255,255,255,0.05); z-index: 100;
        }
        #progress-fill {
            height: 100%; width: 10%; background: var(--primary);
            transition: width 0.4s ease; border-radius: 0 2px 2px 0;
        }

        /* ===== SCENE LAYOUT ===== */
        #presentation { width: 100%; height: 100%; position: relative; }
        .scene {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start;
            padding: 30px 60px 80px 60px;
            opacity: 0; pointer-events: none;
            transition: opacity 0.5s ease, transform 0.5s ease;
            transform: translateX(40px);
            background: radial-gradient(ellipse at center, var(--bg2) 0%, var(--bg) 70%);
            overflow-y: auto;
        }
        .scene.active { opacity: 1; pointer-events: auto; transform: translateX(0); }
        .scene.exit-left { opacity: 0; transform: translateX(-40px); }

        /* ===== NAVIGATION ===== */
        #controls {
            position: fixed; bottom: 0; left: 0; width: 100%;
            display: flex; align-items: center; justify-content: center;
            gap: 24px; padding: 16px; z-index: 100;
            background: linear-gradient(transparent, rgba(10,14,26,0.95));
        }
        #controls button {
            background: var(--surface); border: 1px solid var(--border);
            color: var(--text); padding: 8px 20px; border-radius: 8px;
            font-family: inherit; font-size: 14px; cursor: pointer;
            transition: all 0.2s ease;
        }
        #controls button:hover { background: rgba(74,158,255,0.15); border-color: var(--primary); }
        #controls button:disabled { opacity: 0.3; cursor: default; }
        #scene-dots { display: flex; gap: 8px; }
        .scene-dot {
            width: 10px; height: 10px; border-radius: 50%;
            background: rgba(255,255,255,0.15); cursor: pointer;
            transition: all 0.3s ease;
        }
        .scene-dot.active { background: var(--primary); box-shadow: 0 0 8px var(--primary); }
        .scene-dot.visited { background: rgba(74,158,255,0.4); }

        /* ===== KEYBOARD HINT ===== */
        #keyboard-hint {
            position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%);
            background: var(--surface); border: 1px solid var(--border);
            padding: 8px 16px; border-radius: 8px; font-size: 13px;
            color: var(--text-muted); z-index: 100;
            animation: fadeOut 3s 3s forwards;
        }
        kbd {
            background: rgba(255,255,255,0.1); border: 1px solid var(--border);
            padding: 2px 6px; border-radius: 4px; font-size: 12px;
            font-family: var(--mono);
        }

        /* ===== REUSABLE ANIMATIONS ===== */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; pointer-events: none; } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0); } 70% { transform: scale(1.1); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-40px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes glowPulse { 0%, 100% { box-shadow: 0 0 5px rgba(74,158,255,0.3); } 50% { box-shadow: 0 0 20px rgba(74,158,255,0.6); } }
        @keyframes numberFlip { 0% { transform: rotateX(0deg); } 50% { transform: rotateX(90deg); } 100% { transform: rotateX(0deg); } }
        @keyframes rowInsert { 0% { background: rgba(46,204,113,0.35); } 100% { background: transparent; } }
        @keyframes rowUpdate { 0% { background: rgba(243,156,18,0.35); } 100% { background: transparent; } }
        @keyframes rowPulse { 0%, 100% { background: rgba(74,158,255,0.05); } 50% { background: rgba(74,158,255,0.2); } }

        /* ===== COMPONENT STYLES ===== */
        .glass-card {
            background: var(--surface);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 12px; padding: 24px;
        }
        .scene-title {
            font-size: 28px; font-weight: 700; margin-bottom: 4px;
            background: linear-gradient(135deg, var(--text) 0%, var(--primary) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .scene-subtitle { font-size: 14px; color: var(--text-muted); margin-bottom: 16px; }
        #scene-5 .scene-subtitle,
        #scene-7 .scene-subtitle,
        #scene-8 .scene-subtitle,
        #scene-9 .scene-subtitle { margin-bottom: 28px; }
        #scene-6 .scene-subtitle { margin-bottom: 20px; }
        #scene-10 .scene-subtitle { margin-bottom: 8px; }
        #scene-6.scene { padding: 24px 24px; }
        #scene-10.scene { padding: 16px 20px; }
        #scene-6 .scene-title { font-size: 24px; margin-bottom: 6px; }
        #scene-10 .scene-title { font-size: 22px; margin-bottom: 2px; }
        .anim-item { opacity: 0; }
        .anim-item.show { animation: fadeInUp 0.5s ease forwards; }

        /* Architecture box */
        .arch-box {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 12px 20px; border-radius: 10px;
            background: var(--surface); border: 1px solid var(--border);
            font-size: 14px; font-weight: 600;
            opacity: 0; transform: scale(0);
        }
        .arch-box.visible { animation: popIn 0.4s ease forwards; }
        .arch-box.highlight { border-color: var(--primary); box-shadow: 0 0 15px rgba(74,158,255,0.2); }

        /* ===== STEP CONTROLS (shared across scenes) ===== */
        .step-controls { display: none; }
        #step-controls-global {
            display: none; align-items: center;
            gap: 16px;
            position: fixed; bottom: 20px; right: 32px;
            z-index: 1000;
        }
        #step-controls-global.visible { display: flex; }
        .step-btn {
            background: var(--surface); border: 1px solid var(--border);
            color: var(--text); padding: 6px 16px; border-radius: 6px;
            font-family: inherit; font-size: 13px; cursor: pointer;
            transition: all 0.2s ease;
        }
        .step-btn:hover:not(:disabled) { background: rgba(74,158,255,0.15); border-color: var(--primary); }
        .step-btn:disabled { opacity: 0.3; cursor: default; }
        .step-indicator {
            font-size: 13px; color: var(--text-muted); font-family: var(--mono);
            min-width: 100px; text-align: center;
        }

        /* ===== SHARED PL/SQL BAR (scenes 7-10) ===== */
        .plsql-bar {
            display: flex; gap: 12px; margin-bottom: 12px; justify-content: center;
        }
        .plsql-bar .plsql-func {
            padding: 8px 14px; border-radius: 8px;
            background: var(--surface); border: 1px solid var(--border);
            font-family: var(--mono); font-size: 11px;
            transition: all 0.3s ease; opacity: 0.5;
        }
        .plsql-bar .plsql-func.active {
            opacity: 1; border-color: var(--primary); background: rgba(74,158,255,0.1);
            box-shadow: 0 0 10px rgba(74,158,255,0.2);
        }
        .plsql-bar .plsql-func.done {
            opacity: 0.7; border-color: var(--success); color: var(--success);
        }
        .jdbc-banner {
            text-align: center; margin-bottom: 18px;
            padding: 6px 16px; border-radius: 8px;
            background: rgba(74,158,255,0.1); border: 1px solid rgba(74,158,255,0.3);
            font-weight: 600; font-size: 13px; color: var(--primary);
        }

        .row-data { font-family: var(--mono); font-size: 12px; line-height: 1.8; }
        .row-data .field-name { color: var(--text-muted); }
        .row-data .field-val { color: #c3e88d; }
        .ttl-badge {
            display: inline-flex; align-items: center; gap: 6px;
            font-family: var(--mono); font-size: 12px;
            padding: 4px 10px; border-radius: 4px;
            background: rgba(74,158,255,0.1); color: var(--primary);
        }

        /* ===== DB TABLES PANEL (scenes 5, 7-10) ===== */
        .db-tables-panel {
            display: flex; flex-wrap: wrap; gap: 12px; margin-top: 12px; width: 100%;
            justify-content: center; flex-shrink: 0;
        }
        .db-tables-panel .db-label {
            width: 100%; text-align: center; font-size: 13px;
            color: #ff4f6d; font-weight: 600; margin-bottom: 8px;
            padding: 2px 0;
        }
        .db-mini-table {
            background: rgba(180, 130, 50, 0.08); border: 1px solid rgba(243, 156, 18, 0.3);
            border-radius: 8px; padding: 8px 10px; font-family: var(--mono); font-size: 11px;
            min-width: 220px; max-width: 380px; flex: 1;
        }
        .db-mini-table:last-child { max-width: 480px; }
        .db-mini-table .table-title {
            font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;
            color: var(--warning); margin-bottom: 4px; font-weight: 600;
        }
        .db-mini-table .table-title::before { content: '\1F5C3 '; font-size: 11px; }
        .db-mini-table table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        .db-mini-table th {
            color: rgba(243, 156, 18, 0.7); font-weight: 500; padding: 3px 6px;
            border-bottom: 1px solid rgba(243, 156, 18, 0.2); text-align: left; font-size: 10px;
        }
        .db-mini-table td { padding: 3px 6px; color: #c3e88d; font-size: 11px; }
        .db-mini-table tr.row-insert { animation: rowInsert 1s ease; }
        .db-mini-table tr.row-update { animation: rowUpdate 1s ease; }
        .db-mini-table tr.row-highlight { background: rgba(46,204,113,0.1); }
        .db-mini-table tr.row-full td { color: var(--error); }
        .db-mini-table tr.row-locked td { color: var(--primary); }
        .db-mini-table tr.row-pulse { animation: rowPulse 1s infinite; }
        .db-mini-table .empty-label { color: var(--text-muted); font-style: italic; padding: 6px 0; text-align: center; font-size: 10px; }
        .db-mini-table .sql-hint {
            font-size: 9px; color: var(--warning); margin-top: 3px;
            padding: 2px 4px; background: rgba(243,156,18,0.08); border-radius: 3px;
            display: inline-block;
        }

        /* ===== SCENE 1: TITLE ===== */
        #scene-1 { justify-content: center; }
        #scene-1 .main-title {
            font-size: 56px; font-weight: 700;
            background: linear-gradient(135deg, #fff 0%, var(--primary) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; text-align: center;
        }
        #scene-1 .main-subtitle { font-size: 22px; color: var(--text-muted); margin-top: 12px; text-align: center; }
        #scene-1 .badge-row { display: flex; gap: 12px; margin-top: 40px; flex-wrap: wrap; justify-content: center; }
        #scene-1 .tech-badge {
            padding: 8px 18px; border-radius: 24px;
            font-size: 14px; font-weight: 600;
            background: var(--surface); border: 1px solid var(--border); opacity: 0;
        }
        .badge-blue { border-color: var(--primary) !important; color: var(--primary); }
        .badge-green { border-color: var(--success) !important; color: var(--success); }
        .badge-orange { border-color: var(--warning) !important; color: var(--warning); }
        .badge-red { border-color: var(--error) !important; color: var(--error); }

        /* ===== SCENE 2: ARCHITECTURE ===== */
        #scene-2 { justify-content: center; }
        #scene-2 .arch-container { display: flex; flex-direction: column; align-items: center; gap: 0; position: relative; width: 700px; }
        #scene-2 .arch-row { display: flex; align-items: center; justify-content: center; gap: 20px; position: relative; z-index: 2; }
        #scene-2 .arch-arrow { width: 2px; height: 40px; position: relative; overflow: visible; z-index: 1; }
        #scene-2 .arch-arrow-line { width: 2px; height: 0; background: var(--primary); transition: height 0.4s ease; margin: 0 auto; }
        #scene-2 .arch-arrow-line.drawn { height: 100%; }
        #scene-2 .branch-container { display: flex; gap: 40px; align-items: flex-start; position: relative; }
        #scene-2 .db-tables { display: flex; flex-direction: column; gap: 6px; margin-top: 8px; }
        #scene-2 .db-table-name { font-family: var(--mono); font-size: 11px; color: var(--text-muted); padding: 4px 10px; background: rgba(255,255,255,0.03); border-radius: 4px; border-left: 2px solid var(--warning); }

        /* ===== SCENE 3: TIME WINDOW ===== */
        #scene-3 { justify-content: center; }
        #scene-3 .timeline-container { width: 90%; max-width: 900px; position: relative; margin-top: 24px; }
        #scene-3 .timeline-axis { height: 3px; background: var(--border); width: 0; transition: width 1s ease; border-radius: 2px; }
        #scene-3 .timeline-axis.drawn { width: 100%; }
        #scene-3 .windows-row { display: flex; gap: 8px; margin-top: 16px; justify-content: center; }
        #scene-3 .window-box {
            width: 160px; min-height: 120px; border-radius: 8px;
            border: 1px solid var(--border); background: var(--surface);
            padding: 8px; position: relative; opacity: 0;
            transform: scaleX(0); transform-origin: left center; transition: all 0.4s ease;
        }
        #scene-3 .window-box.visible { opacity: 1; transform: scaleX(1); }
        #scene-3 .window-box.full { border-color: var(--error); }
        #scene-3 .window-label { font-family: var(--mono); font-size: 11px; color: var(--text-muted); text-align: center; margin-bottom: 4px; }
        #scene-3 .window-capacity { font-family: var(--mono); font-size: 12px; text-align: center; font-weight: 600; margin-bottom: 6px; }
        #scene-3 .slots-area { height: 60px; position: relative; }
        #scene-3 .slot-dot { position: absolute; width: 5px; height: 5px; border-radius: 50%; background: var(--primary); opacity: 0; transition: opacity 0.2s ease; }
        #scene-3 .slot-dot.visible { opacity: 0.7; }
        #scene-3 .jitter-label { text-align: center; margin-top: 16px; font-size: 14px; color: var(--text-muted); opacity: 0; transition: opacity 0.5s ease; }
        #scene-3 .jitter-label.visible { opacity: 1; }

        /* ===== SCENE 4: 4-STEP OVERVIEW ===== */
        #scene-4 { justify-content: center; }
        #scene-4 .steps-container { display: flex; flex-direction: column; gap: 16px; width: 600px; }
        #scene-4 .step-card {
            display: flex; align-items: center; gap: 16px;
            padding: 20px; border-radius: 12px;
            background: var(--surface); border: 1px solid var(--border);
            opacity: 0; transform: translateX(-30px);
        }
        #scene-4 .step-card.visible { animation: slideInLeft 0.5s ease forwards; }
        #scene-4 .step-card.active-step {
            opacity: 1; transform: translateX(0);
            border-color: var(--primary);
            animation: glowPulse 2s infinite;
        }
        #scene-4 .step-number {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 18px; flex-shrink: 0;
            background: rgba(74,158,255,0.15); color: var(--primary);
            border: 2px solid var(--primary);
        }
        #scene-4 .step-content h3 { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        #scene-4 .step-content p { font-size: 13px; color: var(--text-muted); }
        #scene-4 .step-connector { width: 2px; height: 16px; background: var(--border); margin-left: 38px; opacity: 0; transition: opacity 0.3s ease; }
        #scene-4 .step-connector.visible { opacity: 1; }

        /* ===== SCENE 5: LOAD CONFIG ===== */
        #scene-5 .config-flow { display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; max-width: 860px; }
        #scene-5 .narrative { font-size: 13px; color: var(--text-muted); max-width: 700px; text-align: center; line-height: 1.6; }
        #scene-5 .flow-row { display: flex; align-items: stretch; gap: 0; justify-content: center; width: 100%; }
        #scene-5 .flow-box {
            padding: 10px 14px; border-radius: 10px;
            background: var(--surface); border: 1px solid var(--border);
            font-size: 12px; font-weight: 600; text-align: center;
            opacity: 0; transition: all 0.4s ease;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            min-width: 130px; max-width: 160px; flex: 1;
        }
        #scene-5 .flow-box.visible { opacity: 1; }
        #scene-5 .flow-box.cache-hit { border-color: var(--success); box-shadow: 0 0 15px rgba(46,204,113,0.2); }
        #scene-5 .flow-box.cache-miss { border-color: var(--error); box-shadow: 0 0 15px rgba(231,76,60,0.2); }
        #scene-5 .flow-arrow-h {
            font-size: 18px; color: var(--primary); opacity: 0;
            transition: opacity 0.3s ease;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; width: 36px;
        }
        #scene-5 .flow-arrow-h.visible { opacity: 1; }
        #scene-5 .path-label {
            font-size: 12px; font-weight: 600; padding: 3px 10px;
            border-radius: 4px; margin-bottom: 6px; display: inline-block;
        }
        #scene-5 .path-label.fast { background: rgba(46,204,113,0.15); color: var(--success); }
        #scene-5 .path-label.slow { background: rgba(231,76,60,0.15); color: var(--error); }
        #scene-5 .config-card { font-family: var(--mono); font-size: 12px; width: 100%; max-width: 400px; padding: 16px; }
        #scene-5 .timing-badge {
            display: inline-block; font-family: var(--mono); font-size: 10px;
            padding: 2px 6px; border-radius: 3px; margin-top: 4px;
        }

        /* ===== SCENE 6: SEARCH PARAMS ===== */
        #scene-6 .params-container { width: 100%; max-width: 820px; margin-top: 12px; }
        #scene-6 .param-row {
            display: flex; align-items: flex-start; gap: 12px;
            padding: 9px 14px; border-radius: 8px;
            background: var(--surface); border: 1px solid var(--border);
            margin-bottom: 8px;
            opacity: 0; transition: all 0.4s ease;
        }
        #scene-6 .param-row.visible { opacity: 1; }
        #scene-6 .param-name {
            font-family: var(--mono); font-size: 12px; font-weight: 600;
            min-width: 160px; flex-shrink: 0;
        }
        #scene-6 .param-value {
            font-family: var(--mono); font-size: 12px; font-weight: 600;
            min-width: 170px; flex-shrink: 0;
        }
        #scene-6 .param-desc {
            font-size: 11px; color: var(--text-muted); line-height: 1.4;
        }
        #scene-6 .param-formula {
            font-family: var(--mono); font-size: 10px;
            padding: 2px 6px; border-radius: 4px;
            background: var(--code-bg); border: 1px solid var(--border);
            display: inline-block; margin-top: 2px;
        }
        #scene-6 .param-formula .kw { color: #c792ea; }
        #scene-6 .step-desc {
            text-align: center; font-size: 11px; color: var(--text-muted);
            margin-top: 6px; min-height: 16px;
            transition: opacity 0.3s ease;
        }

        /* ===== SCENE 7: IDEMPOTENCY ===== */
        #scene-7 .idem-container { width: 100%; max-width: 820px; }
        #scene-7 .idem-paths { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        #scene-7 .idem-path {
            padding: 10px 14px; border-radius: 10px;
            background: var(--surface); border: 1px solid var(--border);
            opacity: 0; transition: all 0.4s ease;
            max-width: 360px; margin: 0 auto; width: 100%;
            display: flex; flex-direction: column; justify-content: center;
        }
        #scene-7 .idem-path.visible { opacity: 1; }
        #scene-7 .idem-path h4 { font-size: 12px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        #scene-7 .idem-step {
            font-size: 11px; color: var(--text-muted); margin-bottom: 5px;
            padding-left: 8px; border-left: 2px solid var(--border);
            opacity: 0; transition: opacity 0.3s ease;
        }
        #scene-7 .idem-step.visible { opacity: 1; }
        .status-badge {
            display: inline-block; padding: 3px 8px; border-radius: 4px;
            font-family: var(--mono); font-size: 10px; font-weight: 600;
        }

        /* ===== SCENE 8: FIND FIRST OPEN WINDOW ===== */
        #scene-8 .skip-container { width: 100%; max-width: 820px; }
        #scene-8 .skip-paths { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        #scene-8 .skip-path { flex: 1; min-width: 160px; max-width: 220px; }
        #scene-8 .skip-path {
            padding: 10px 12px; border-radius: 10px;
            background: var(--surface); border: 1px solid var(--border);
            opacity: 0; transition: all 0.4s ease;
            display: flex; flex-direction: column; justify-content: center;
        }
        #scene-8 .skip-path.visible { opacity: 1; }
        #scene-8 .skip-path h4 { font-size: 11px; margin-bottom: 8px; color: var(--text); }
        #scene-8 .skip-step {
            font-size: 10px; color: var(--text-muted); margin-bottom: 5px;
            padding-left: 8px; border-left: 2px solid var(--border);
            opacity: 0; transition: opacity 0.3s ease;
        }
        #scene-8 .skip-step.visible { opacity: 1; }
        #scene-8 .skip-sql {
            font-family: var(--mono); font-size: 11px;
            padding: 10px 14px; border-radius: 8px;
            background: var(--code-bg); border: 1px solid var(--border);
            margin-bottom: 12px; text-align: center;
            opacity: 0; transition: opacity 0.5s ease;
        }
        #scene-8 .skip-sql.visible { opacity: 1; }
        #scene-8 .skip-result {
            text-align: center; font-size: 13px; font-weight: 600;
            padding: 8px 16px; border-radius: 8px;
            background: var(--surface); border: 1px solid var(--border);
            opacity: 0; transition: opacity 0.5s ease;
        }
        #scene-8 .skip-result.visible { opacity: 1; }

        /* ===== SCENE 9: WINDOW WALK ===== */
        #scene-9 .walk-container { width: 90%; max-width: 900px; }
        #scene-9 .thread-legend { display: flex; gap: 16px; margin-bottom: 10px; justify-content: center; }
        #scene-9 .thread-tag { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 600; }
        #scene-9 .thread-dot { width: 12px; height: 12px; border-radius: 50%; }
        #scene-9 .walk-timeline { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; position: relative; }
        #scene-9 .walk-window {
            width: 130px; min-height: 70px; border-radius: 8px;
            border: 1px solid var(--border); background: var(--surface);
            padding: 8px; text-align: center; position: relative;
            opacity: 0; transition: all 0.4s ease;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #scene-9 .walk-window.visible { opacity: 1; }
        #scene-9 .walk-window .win-time { font-family: var(--mono); font-size: 11px; color: var(--text-muted); margin-bottom: 4px; }
        #scene-9 .walk-window .win-lock { font-size: 16px; margin: 4px 0; opacity: 0; transition: opacity 0.3s ease; }
        #scene-9 .walk-window .win-lock.visible { opacity: 1; }
        #scene-9 .walk-window .win-status { font-size: 11px; font-weight: 600; opacity: 0; transition: opacity 0.3s ease; }
        #scene-9 .walk-window .win-status.visible { opacity: 1; }
        #scene-9 .thread-anim-area { height: 80px; position: relative; margin-bottom: 8px; }
        #scene-9 .thread-circle {
            width: 26px; height: 26px; border-radius: 50%;
            position: absolute; display: flex; align-items: center;
            justify-content: center; font-size: 10px; font-weight: 700;
            color: #fff; transition: all 0.6s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        #scene-9 .thread-circle.bounce { transition: all 0.8s cubic-bezier(0.25, -0.5, 0.25, 1.5); }
        #scene-9 .nowait-label { text-align: center; font-size: 18px; font-weight: 700; color: var(--warning); opacity: 0; transition: opacity 0.5s ease; }
        #scene-9 .nowait-label.visible { opacity: 1; }
        #scene-9 .sql-caption {
            text-align: center; margin-top: 6px;
            font-family: var(--mono); font-size: 11px; color: var(--text-muted);
            opacity: 0; transition: opacity 0.5s ease;
        }
        #scene-9 .sql-caption.visible { opacity: 1; }

        /* ===== SCENE 10: CLAIM SLOT ===== */
        #scene-10 .claim-container { width: 100%; max-width: 820px; }
        #scene-10 .plsql-bar { margin-bottom: 6px; }
        #scene-10 .jdbc-banner { margin-bottom: 6px; font-size: 11px; padding: 4px 12px; }
        #scene-10 .row-data { font-size: 11px; line-height: 1.5; }
        #scene-10 .jitter-box {
            text-align: center; margin-bottom: 6px; padding: 6px 10px;
            border-radius: 8px; background: var(--surface); border: 1px solid var(--border);
            opacity: 0; transition: opacity 0.5s ease;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #scene-10 .jitter-box.visible { opacity: 1; }
        #scene-10 .jitter-formula { font-family: var(--mono); font-size: 11px; color: var(--text-muted); margin-bottom: 4px; }
        #scene-10 .jitter-reel { font-family: var(--mono); font-size: 28px; font-weight: 700; color: var(--primary); height: 36px; overflow: hidden; display: inline-block; }
        #scene-10 .sched-calc {
            font-family: var(--mono); font-size: 11px; margin: 4px 0;
            text-align: center; opacity: 0; transition: opacity 0.5s ease;
        }
        #scene-10 .sched-calc.visible { opacity: 1; }
        #scene-10 .sched-calc .time-val { color: var(--success); font-weight: 600; }
        #scene-10 .insert-card { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 4px; }
        #scene-10 .insert-panel {
            padding: 8px; border-radius: 8px;
            background: var(--surface); border: 1px solid var(--border);
            opacity: 0; transition: all 0.4s ease;
        }
        #scene-10 .insert-panel.visible { opacity: 1; }
        #scene-10 .insert-panel h4 { font-size: 11px; color: var(--text-muted); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        #scene-10 .counter-display { font-family: var(--mono); font-size: 24px; font-weight: 700; text-align: center; color: var(--success); perspective: 200px; }
        #scene-10 .counter-display .counter-val { display: inline-block; transition: transform 0.4s ease; }
        #scene-10 .counter-display .counter-val.flipping { animation: numberFlip 0.4s ease; }

        /* ===== SCENE 11: RESULTS ===== */
        #scene-11 { justify-content: center; }
        #scene-11 .results-container { width: 800px; }
        #scene-11 .result-paths { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 24px; }
        #scene-11 .result-card {
            padding: 20px; border-radius: 10px; text-align: center;
            background: var(--surface); border: 2px solid var(--border);
            opacity: 0; transition: all 0.3s ease; cursor: pointer;
        }
        #scene-11 .result-card.visible { opacity: 1; }
        #scene-11 .result-card:hover { border-color: rgba(255,255,255,0.25); transform: translateY(-2px); }
        #scene-11 .result-card.active-result { transform: scale(1.05); }
        #scene-11 .result-card.active-result.result-new-card { border-color: var(--success); box-shadow: 0 0 15px rgba(46,204,113,0.3); }
        #scene-11 .result-card.active-result.result-existing-card { border-color: var(--primary); box-shadow: 0 0 15px rgba(74,158,255,0.3); }
        #scene-11 .result-card.active-result.result-exhausted-card { border-color: var(--error); box-shadow: 0 0 15px rgba(231,76,60,0.3); }
        #scene-11 .result-card h4 { font-size: 14px; margin-bottom: 8px; }
        #scene-11 .result-card .http-badge {
            display: inline-block; padding: 4px 12px; border-radius: 4px;
            font-family: var(--mono); font-size: 13px; font-weight: 700; margin: 8px 0;
        }
        #scene-11 .result-card .result-desc { font-size: 12px; color: var(--text-muted); }
        #scene-11 .response-json { max-width: 500px; margin: 0 auto; transition: all 0.3s ease; }
        #scene-11 .response-json .resp-header { font-weight: 600; margin-bottom: 8px; }
        #scene-11 .response-json .resp-note { font-size: 12px; margin-top: 8px; font-style: italic; }
        #scene-11 .summary-replay { margin-top: 20px; text-align: center; }
        #scene-11 .replay-flow { display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
        #scene-11 .replay-node {
            padding: 6px 14px; border-radius: 6px; font-size: 12px;
            background: var(--surface); border: 1px solid var(--border);
            opacity: 0; transition: all 0.3s ease;
        }
        #scene-11 .replay-node.visible { opacity: 1; }
        #scene-11 .replay-node.active-node { border-color: var(--primary); background: rgba(74,158,255,0.15); }
        #scene-11 .replay-arrow { color: var(--primary); font-size: 14px; opacity: 0; transition: opacity 0.2s ease; }
        #scene-11 .replay-arrow.visible { opacity: 1; }

    </style>
</head>
<body>

<!-- Progress Bar -->
<div id="progress-bar"><div id="progress-fill"></div></div>

<!-- Presentation -->
<div id="presentation">

    <!-- ===== SCENE 1: TITLE ===== -->
    <section class="scene active" id="scene-1">
        <div class="main-title anim-item">Slot Assignment Service</div>
        <div class="main-subtitle anim-item">Oracle-based Rate Limiter for High-Throughput Event Scheduling</div>
        <div style="margin-top: 4px; font-size: 15px; color: var(--text-muted);" class="anim-item">
            Supports up to <span style="color: var(--primary); font-weight: 700;">1,000,000</span> events / day
        </div>
        <div style="margin-top: 8px; font-size: 13px; color: var(--text-muted);" class="anim-item">
            <span style="color: var(--warning); font-weight: 600;">Kotlin/Exposed</span> &bull; <span style="color: var(--error); font-weight: 600;">PL/SQL</span>
        </div>
        <div class="badge-row">
            <div class="tech-badge badge-blue">Quarkus 3.x</div>
            <div class="tech-badge badge-green">Kotlin</div>
            <div class="tech-badge badge-orange">Oracle 19c</div>
            <div class="tech-badge badge-red">PL/SQL</div>
        </div>
    </section>

    <!-- ===== SCENE 2: ARCHITECTURE ===== -->
    <section class="scene" id="scene-2">
        <div class="scene-title anim-item">Architecture</div>
        <div class="scene-subtitle anim-item">Component flow from API to database</div>
        <div class="arch-container">
            <div class="arch-row"><div class="arch-box" id="arch-client">Client</div></div>
            <div class="arch-arrow"><div class="arch-arrow-line" id="arrow-1"></div></div>
            <div class="arch-row"><div class="arch-box" id="arch-api" style="font-family: var(--mono); font-size: 12px;">POST /api/v1/slots</div></div>
            <div class="arch-arrow"><div class="arch-arrow-line" id="arrow-2"></div></div>
            <div class="arch-row"><div class="arch-box" id="arch-resource">SlotAssignmentResource</div></div>
            <div class="arch-arrow"><div class="arch-arrow-line" id="arrow-3"></div></div>
            <div class="arch-row"><div class="arch-box highlight" id="arch-service">SlotAssignmentService</div></div>
            <div class="arch-arrow"><div class="arch-arrow-line" id="arrow-4"></div></div>
            <div class="branch-container">
                <div class="arch-box" id="arch-config">
                    RateLimitConfigRepository
                    <br><span class="ttl-badge" style="margin-top: 6px;">TTL: 5s cache</span>
                </div>
                <div class="arch-box" id="arch-sql">
                    SlotAssignmentSql
                    <br><span style="font-size: 11px; color: var(--text-muted);">PL/SQL execution</span>
                </div>
            </div>
            <div class="arch-arrow"><div class="arch-arrow-line" id="arrow-5"></div></div>
            <div class="arch-row">
                <div class="arch-box" id="arch-db" style="flex-direction: column; align-items: center;">
                    <span>Oracle Database</span>
                    <div class="db-tables">
                        <div class="db-table-name">rate_limit_config</div>
                        <div class="db-table-name">rate_limit_window_counter</div>
                        <div class="db-table-name">rate_limit_event_slot</div>
                        <div class="db-table-name">track_window_end</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ===== SCENE 3: TIME WINDOW MODEL ===== -->
    <section class="scene" id="scene-3">
        <div class="scene-title anim-item">The Time Window Model</div>
        <div class="scene-subtitle anim-item">Events are distributed across fixed-size time windows with random jitter</div>
        <div class="timeline-container">
            <div class="timeline-axis" id="timeline-axis-3"></div>
            <div class="windows-row" id="windows-row-3"></div>
            <div class="jitter-label" id="jitter-label-3">
                Each dot = one event. Random jitter spreads events uniformly within each <span style="color: var(--primary); font-weight: 600;">4-second</span> window
            </div>
        </div>
    </section>

    <!-- ===== SCENE 4: 4-STEP OVERVIEW ===== -->
    <section class="scene" id="scene-4">
        <div class="scene-title anim-item">The 4-Step Core Flow</div>
        <div class="scene-subtitle anim-item">Every slot assignment follows this path</div>
        <div class="steps-container">
            <div class="step-card" id="step-1">
                <div class="step-number">1</div>
                <div class="step-content"><h3>Load Configuration</h3><p>Check cached config (5s TTL), fallback to DB query</p></div>
            </div>
            <div class="step-connector" id="conn-1"></div>
            <div class="step-card" id="step-2">
                <div class="step-number">2</div>
                <div class="step-content"><h3>Compute Search Params</h3><p>Align to window boundary, compute elapsed time &amp; chunk sizes</p></div>
            </div>
            <div class="step-connector" id="conn-2"></div>
            <div class="step-card" id="step-3">
                <div class="step-number">3</div>
                <div class="step-content"><h3>Single Transaction</h3><p>Idempotency check, find+lock, extension loop &mdash; all in one transaction</p></div>
            </div>
            <div class="step-connector" id="conn-3"></div>
            <div class="step-card" id="step-4">
                <div class="step-number">4</div>
                <div class="step-content"><h3>Interpret Results</h3><p>Return scheduled time with delay to caller</p></div>
            </div>
        </div>
    </section>

    <!-- ===== SCENE 5: LOAD CONFIG ===== -->
    <section class="scene" id="scene-5">
        <div class="scene-title">Step 1: Load Configuration</div>
        <div class="scene-subtitle">In-memory cache with 5-second TTL minimizes DB hits on the hot path</div>
        <div class="config-flow">
            <div class="narrative" id="s5-narrative" style="opacity: 0; transition: opacity 0.5s;">
                The service calls <code style="color: var(--primary);">RateLimitConfigRepository.loadActiveConfig(configName)</code>.
                An in-memory <strong style="color: var(--primary);">ConcurrentHashMap</strong> cache (5s TTL) is checked first.
                On a miss, it queries the <strong style="color: var(--warning);">rate_limit_config</strong> table.
            </div>
            <div style="opacity: 0; transition: opacity 0.5s; width: 100%;" id="path-hit-container">
                <div class="path-label fast">CACHE HIT (fast path) <span class="timing-badge" style="background: rgba(46,204,113,0.15); color: var(--success);">~0ms</span></div>
                <div class="flow-row">
                    <div class="flow-box visible">loadActive<br>Config()</div>
                    <div class="flow-arrow-h visible">&#8594;</div>
                    <div class="flow-box cache-hit visible">ConcurrentHashMap<br><span class="ttl-badge" style="font-size:10px;">TTL 5s</span></div>
                    <div class="flow-arrow-h visible">&#8594;</div>
                    <div class="flow-box visible" style="border-color: var(--success);">RateLimitConfig<br><span style="font-size:10px;color:var(--success);">&#10003; returned instantly</span></div>
                </div>
            </div>
            <div style="opacity: 0; transition: opacity 0.5s; width: 100%;" id="path-miss-container">
                <div class="path-label slow">CACHE MISS (cold path) <span class="timing-badge" style="background: rgba(231,76,60,0.15); color: var(--error);">~2-5ms</span></div>
                <div class="flow-row">
                    <div class="flow-box visible">loadActive<br>Config()</div>
                    <div class="flow-arrow-h visible">&#8594;</div>
                    <div class="flow-box cache-miss visible">Cache<br><span style="color: var(--error);">MISS</span></div>
                    <div class="flow-arrow-h visible">&#8594;</div>
                    <div class="flow-box visible" style="border-color: var(--warning);">Oracle DB<br><span style="font-size:9px;color:var(--text-muted);">SELECT * FROM<br>rate_limit_config<br>WHERE is_active = 1</span></div>
                    <div class="flow-arrow-h visible">&#8594;</div>
                    <div class="flow-box visible" style="border-color: var(--success);">Cache +<br>Return</div>
                </div>
            </div>
            <div class="glass-card config-card" id="config-result-card" style="opacity: 0; transition: opacity 0.5s;">
                <div style="font-weight: 600; margin-bottom: 6px; color: var(--text);">Loaded RateLimitConfig</div>
                <div class="row-data">
                    <span class="field-name">configId:</span> <span class="field-val">1</span><br>
                    <span class="field-name">configName:</span> <span class="field-val">"default"</span><br>
                    <span class="field-name">maxPerWindow:</span> <span class="field-val">100</span> <span style="color: var(--text-muted);">// max slots per window</span><br>
                    <span class="field-name">windowSizeSecs:</span> <span class="field-val">4</span> <span style="color: var(--text-muted);">// 4 seconds</span><br>
                    <span class="field-name">windowSizeMs:</span> <span class="field-val">4000</span> <span style="color: var(--text-muted);">// for jitter calculation</span><br>
                    <span class="field-name">isActive:</span> <span class="field-val">true</span>
                </div>
            </div>
        </div>
        <div class="step-controls" id="step-controls-5">
            <button class="step-btn" id="s5-prev" disabled>&#9664;</button>
            <span class="step-indicator" id="s5-indicator">Step 1 / 3</span>
            <button class="step-btn" id="s5-next">&#9654;</button>
        </div>
    </section>

    <!-- ===== SCENE 6: COMPUTE SEARCH PARAMS ===== -->
    <section class="scene" id="scene-6">
        <div class="scene-title">Step 2: Compute Search Parameters</div>
        <div class="scene-subtitle">Kotlin pre-computes these values before the single transaction</div>
        <div class="params-container">
            <div class="param-row" id="param-1">
                <div class="param-name" style="color: var(--warning);">requestedTime</div>
                <div class="param-value" style="color: #c3e88d;">12:00:01.500</div>
                <div class="param-desc">
                    Timestamp from the incoming API call.
                    <br><span style="color: var(--text-muted); font-style: italic;">Input to the algorithm &mdash; when the caller wants the event processed.</span>
                </div>
            </div>
            <div class="param-row" id="param-2">
                <div class="param-name" style="color: var(--success);">windowStart</div>
                <div class="param-value" style="color: #c3e88d;">12:00:00.000</div>
                <div class="param-desc">
                    Snap requestedTime down to the nearest window boundary.
                    <div class="param-formula"><span class="kw">epochSecond</span> - (epochSecond <span class="kw">%</span> windowSizeSecs)</div>
                </div>
            </div>
            <div class="param-row" id="param-3">
                <div class="param-name" style="color: var(--primary);">elapsedMs</div>
                <div class="param-value" style="color: #c3e88d;">1500</div>
                <div class="param-desc">
                    Milliseconds elapsed between windowStart and requestedTime. Used to constrain jitter so <code style="color:var(--primary);">scheduledTime &ge; requestedTime</code>.
                    <div class="param-formula"><span class="kw">Duration</span>.between(windowStart, requestedTime).toMillis()</div>
                </div>
            </div>
            <div class="param-row" id="param-4">
                <div class="param-name" style="color: var(--primary);">maxFirstWindow</div>
                <div class="param-value" style="color: #c3e88d;">62</div>
                <div class="param-desc">
                    Proportional capacity for the partial first window. Since 1500ms has elapsed, only 2500ms remain &mdash; capacity is scaled down.
                    <div class="param-formula"><span class="kw">floor</span>(100 &times; 2500 / 4000) = 62</div>
                </div>
            </div>
            <div class="param-row" id="param-5">
                <div class="param-name" style="color: var(--primary);">firstJitterMs</div>
                <div class="param-value" style="color: #c3e88d;">random(1500, 4000)</div>
                <div class="param-desc">
                    Jitter for the first window, constrained to <code style="color:var(--primary);">[elapsedMs, windowSizeMs)</code> so scheduled time is never in the past.
                    <div class="param-formula"><span class="kw">ThreadLocalRandom</span>.nextLong(elapsedMs, windowSizeMs)</div>
                </div>
            </div>
            <div class="param-row" id="param-6">
                <div class="param-name" style="color: var(--primary);">fullJitterMs</div>
                <div class="param-value" style="color: #c3e88d;">random(0, 4000)</div>
                <div class="param-desc">
                    Jitter for subsequent full windows. Spans the entire window range.
                    <div class="param-formula"><span class="kw">ThreadLocalRandom</span>.nextLong(0, windowSizeMs)</div>
                </div>
            </div>
            <div class="param-row" id="param-7">
                <div class="param-name" style="color: var(--warning);">maxWindowsInChunk</div>
                <div class="param-value" style="color: #c3e88d;">100</div>
                <div class="param-desc">
                    Number of windows provisioned per chunk. Each chunk is batch-inserted if the last window does not yet exist.
                    <div class="param-formula"><span class="kw">config</span>.maxWindowsInChunk = 100</div>
                </div>
            </div>
            <div class="param-row" id="param-8">
                <div class="param-name" style="color: var(--warning);">maxChunksToSearch</div>
                <div class="param-value" style="color: #c3e88d;">10</div>
                <div class="param-desc">
                    Maximum number of chunks the extension loop will scan before giving up (STATUS_EXHAUSTED).
                    <div class="param-formula"><span class="kw">config</span>.maxChunksToSearch = 10 &rarr; up to 1000 windows total</div>
                </div>
            </div>
        </div>
        <div class="step-desc" id="s6-desc"></div>
        <div class="step-controls" id="step-controls-6">
            <button class="step-btn" id="s6-prev" disabled>&#9664;</button>
            <span class="step-indicator" id="s6-indicator">Step 1 / 7</span>
            <button class="step-btn" id="s6-next">&#9654;</button>
        </div>
    </section>

    <!-- ===== SCENE 7: IDEMPOTENCY ===== -->
    <section class="scene" id="scene-7">
        <div class="scene-title">Step 3: Single Transaction</div>
        <div class="scene-subtitle">Phase 0 &mdash; Idempotency &mdash; Same event_id always returns the same slot</div>
        <div class="idem-container">
            <div class="jdbc-banner" id="jdbc-banner-7">Single Transaction &mdash; all phases in one atomic unit</div>
            <div class="plsql-bar" id="plsql-bar-7">
                <div class="plsql-func active" id="func-check-7">checkExistingSlot</div>
                <div class="plsql-func" id="func-first-7">tryLockFirstWindow</div>
                <div class="plsql-func" id="func-find-7">findAndLockFirstAvailable</div>
                <div class="plsql-func" id="func-claim-7">claimSlot</div>
            </div>
            <div class="idem-paths">
                <div class="idem-path" id="idem-first-call">
                    <h4><span style="color: var(--warning);">First Call</span> &mdash; event_id = "pay-456"</h4>
                    <div class="idem-step" id="idem-s1">SELECT slot_id, scheduled_time, window_start<br>FROM rate_limit_event_slot<br>WHERE event_id = 'pay-456'</div>
                    <div class="idem-step" id="idem-s2" style="border-left-color: var(--error);">
                        NO_DATA_FOUND
                        <span style="display: block; color: var(--error);">&#10007; Not in DB yet</span>
                    </div>
                    <div class="idem-step" id="idem-s3" style="border-left-color: var(--primary);">
                        &#8594; Proceed to tryLockFirstWindow()...
                    </div>
                </div>
                <div class="idem-path" id="idem-second-call">
                    <h4><span style="color: var(--success);">Second Call</span> &mdash; same event_id = "pay-456"</h4>
                    <div class="idem-step" id="idem-s4">SELECT slot_id, scheduled_time, window_start<br>FROM rate_limit_event_slot<br>WHERE event_id = 'pay-456'</div>
                    <div class="idem-step" id="idem-s5" style="border-left-color: var(--success);">
                        ROW FOUND!
                        <span style="display: block; color: var(--success);">&#10003; scheduledTime = 12:00:06.371</span>
                    </div>
                    <div class="idem-step" id="idem-s6" style="border-left-color: var(--success);">
                        Return immediately
                        <span class="status-badge" style="background: rgba(46,204,113,0.15); color: var(--success);">STATUS_EXISTING = 0</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="db-tables-panel" id="db-tables-7"></div>
        <div class="step-controls" id="step-controls-7">
            <button class="step-btn" id="s7-prev" disabled>&#9664;</button>
            <span class="step-indicator" id="s7-indicator">Step 1 / 4</span>
            <button class="step-btn" id="s7-next">&#9654;</button>
        </div>
    </section>

    <!-- ===== SCENE 8: PHASE 1 â€” FIRST WINDOW ===== -->
    <section class="scene" id="scene-8">
        <div class="scene-title">Step 3: Single Transaction</div>
        <div class="scene-subtitle">Phase 1 &mdash; First Window (Proportional Capacity)</div>
        <div class="skip-container">
            <div class="jdbc-banner">Single Transaction &mdash; all phases in one atomic unit</div>
            <div class="plsql-bar" id="plsql-bar-8">
                <div class="plsql-func done">checkExistingSlot</div>
                <div class="plsql-func active" id="func-first-8">tryLockFirstWindow</div>
                <div class="plsql-func" id="func-find-8">findAndLockFirstAvailable</div>
                <div class="plsql-func" id="func-claim-8">claimSlot</div>
            </div>
            <div class="skip-sql" id="skip-sql-8">
                <span style="color: #c792ea;">INSERT INTO</span> window_counter(window_start, slot_count) <span style="color: #c792ea;">VALUES</span>(alignedStart, 0) <span style="color: var(--text-muted);">&mdash; catch DUP</span><br>
                <span style="color: #c792ea;">SELECT</span> slot_count <span style="color: #c792ea;">FROM</span> window_counter
                <span style="color: #c792ea;">WHERE</span> window_start = alignedStart
                <span style="color: var(--warning); font-weight: 600;">FOR UPDATE SKIP LOCKED</span>
            </div>
            <div class="skip-paths" id="skip-paths-8">
                <div class="skip-path" id="skip-case-1">
                    <h4 style="color: var(--success);">ensureWindowExists(alignedStart)</h4>
                    <div class="skip-step" id="skip-s1a">INSERT window_counter (catch DUP_VAL_ON_INDEX)<br>Guarantees the first window row exists</div>
                    <div class="skip-step" id="skip-s1b" style="border-left-color: var(--success);">
                        &#10003; First thread inserts, others catch DUP<br>
                        <span style="color: var(--success);">No thundering herd on initial window</span>
                    </div>
                </div>
                <div class="skip-path" id="skip-case-2">
                    <h4 style="color: var(--warning);">tryLockFirstWindow()</h4>
                    <div class="skip-step" id="skip-s2a">SELECT slot_count FOR UPDATE SKIP LOCKED<br>Lock the first window if not contended</div>
                    <div class="skip-step" id="skip-s2b" style="border-left-color: var(--warning);">
                        Check: count &lt; maxFirstWindow?<br>
                        <span style="color: var(--warning);">maxFirstWindow = floor(maxPerWindow &times; remainingMs / windowSizeMs)</span>
                    </div>
                    <div class="skip-step" id="skip-s2c" style="border-left-color: var(--warning);">
                        If yes &rarr; claimSlot with constrained jitter<br>
                        <span style="color: var(--success);">jitter in [elapsedMs, windowSizeMs)</span>
                    </div>
                </div>
                <div class="skip-path" id="skip-case-3">
                    <h4 style="color: var(--primary);">First window full or locked?</h4>
                    <div class="skip-step" id="skip-s3a">SKIP LOCKED &rarr; no row returned (contended)<br>OR count &ge; maxFirstWindow (full)</div>
                    <div class="skip-step" id="skip-s3b" style="border-left-color: var(--primary);">
                        Fall through to Phase 2<br>
                        <span style="color: var(--primary);">findAndLockFirstAvailable()</span>
                    </div>
                </div>
            </div>
            <div class="skip-result" id="skip-result-8">
                <span style="color: var(--text-muted);">Result:</span> Either slot claimed in first window, or proceed to frontier-tracked find+lock
            </div>
        </div>
        <div class="db-tables-panel" id="db-tables-8"></div>
        <div class="step-controls" id="step-controls-8">
            <button class="step-btn" id="s8-prev" disabled>&#9664;</button>
            <span class="step-indicator" id="s8-indicator">Step 1 / 5</span>
            <button class="step-btn" id="s8-next">&#9654;</button>
        </div>
    </section>

    <!-- ===== SCENE 9: PHASE 2 â€” FRONTIER-TRACKED FIND+LOCK ===== -->
    <section class="scene" id="scene-9">
        <div class="scene-title">Step 3: Single Transaction</div>
        <div class="scene-subtitle">Phase 2 &mdash; Frontier-Tracked Find+Lock</div>
        <div class="walk-container">
            <div class="jdbc-banner">Single Transaction &mdash; all phases in one atomic unit</div>
            <div class="plsql-bar" id="plsql-bar-9">
                <div class="plsql-func done">checkExistingSlot</div>
                <div class="plsql-func done">tryLockFirstWindow</div>
                <div class="plsql-func active" id="func-find-9">findAndLockFirstAvailable</div>
                <div class="plsql-func" id="func-claim-9">claimSlot</div>
            </div>
            <div class="thread-legend">
                <div class="thread-tag"><div class="thread-dot" style="background: #4a9eff;"></div> Thread 1</div>
                <div class="thread-tag"><div class="thread-dot" style="background: #f39c12;"></div> Thread 2</div>
                <div class="thread-tag"><div class="thread-dot" style="background: #2ecc71;"></div> Thread 3</div>
            </div>
            <div class="thread-anim-area" id="thread-area-9">
                <div class="thread-circle" id="t1" style="background: #4a9eff; left: 60px; top: 30px;">T1</div>
                <div class="thread-circle" id="t2" style="background: #f39c12; left: 60px; top: 30px;">T2</div>
                <div class="thread-circle" id="t3" style="background: #2ecc71; left: 60px; top: 30px;">T3</div>
            </div>
            <div class="walk-timeline" id="walk-timeline-9">
                <div class="walk-window" id="ww-0"><div class="win-time">12:00:00</div><div class="win-lock" id="lock-0">&#128274;</div><div class="win-status" id="status-0"></div></div>
                <div class="walk-window" id="ww-1"><div class="win-time">12:00:04</div><div class="win-lock" id="lock-1">&#128274;</div><div class="win-status" id="status-1"></div></div>
                <div class="walk-window" id="ww-2"><div class="win-time">12:00:08</div><div class="win-lock" id="lock-2">&#128274;</div><div class="win-status" id="status-2"></div></div>
                <div class="walk-window" id="ww-3"><div class="win-time">12:00:12</div><div class="win-lock" id="lock-3">&#128274;</div><div class="win-status" id="status-3"></div></div>
            </div>
            <div class="sql-caption" id="sql-caption-9">
                SELECT window_start FROM window_counter WHERE slot_count &lt; maxPerWindow ORDER BY window_start <span style="color: var(--warning); font-weight: 600;">FOR UPDATE SKIP LOCKED</span> FETCH FIRST 1 ROW ONLY
            </div>
            <div class="nowait-label" id="nowait-label-9">SKIP LOCKED &mdash; skip contended rows atomically!</div>
        </div>
        <div class="db-tables-panel" id="db-tables-9"></div>
        <div class="step-controls" id="step-controls-9">
            <button class="step-btn" id="s9-prev" disabled>&#9664;</button>
            <span class="step-indicator" id="s9-indicator">Step 1 / 5</span>
            <button class="step-btn" id="s9-next">&#9654;</button>
        </div>
    </section>

    <!-- ===== SCENE 10: CLAIM SLOT ===== -->
    <section class="scene" id="scene-10">
        <div class="scene-title">Step 3: Single Transaction</div>
        <div class="scene-subtitle">Phase 3 &mdash; Claim Slot &mdash; Insert with jitter, increment counter</div>
        <div class="claim-container">
            <div class="jdbc-banner">Single Transaction &mdash; all phases in one atomic unit</div>
            <div class="plsql-bar" id="plsql-bar-10">
                <div class="plsql-func done">checkExistingSlot</div>
                <div class="plsql-func done">tryLockFirstWindow</div>
                <div class="plsql-func done">findAndLockFirstAvailable</div>
                <div class="plsql-func active" id="func-claim-10">claimSlot</div>
            </div>
            <!-- App Server note (outside jitter box) -->
            <div id="app-server-note-10" style="text-align: center; margin-bottom: 5px; padding: 5px 12px; border-radius: 8px; background: rgba(46,204,113,0.08); border: 1px dashed var(--success); font-size: 11px; color: var(--success); opacity: 0; transition: opacity 0.5s;">
                <strong>App Server (Kotlin)</strong> &mdash; Jitter pre-computed: ThreadLocalRandom.nextLong(elapsedMs, windowSizeMs)
            </div>
            <!-- Three jitter boxes -->
            <div style="display: flex; gap: 8px; justify-content: center; width: 100%;" id="jitter-row-10">
                <div class="jitter-box" id="jitter-box-t1" style="flex: 1; padding: 7px;">
                    <div style="font-size: 10px; font-weight: 600; color: #4a9eff; margin-bottom: 2px;">T1 &rarr; 12:00:04</div>
                    <div class="jitter-reel" id="jitter-reel-t1" style="font-size: 24px;">0000</div>
                    <div style="font-size: 10px; color: var(--text-muted);">ms</div>
                </div>
                <div class="jitter-box" id="jitter-box-t2" style="flex: 1; padding: 7px;">
                    <div style="font-size: 10px; font-weight: 600; color: #f39c12; margin-bottom: 2px;">T2 &rarr; 12:00:08</div>
                    <div class="jitter-reel" id="jitter-reel-t2" style="font-size: 24px;">0000</div>
                    <div style="font-size: 10px; color: var(--text-muted);">ms</div>
                </div>
                <div class="jitter-box" id="jitter-box-t3" style="flex: 1; padding: 7px;">
                    <div style="font-size: 10px; font-weight: 600; color: #2ecc71; margin-bottom: 2px;">T3 &rarr; 12:00:12</div>
                    <div class="jitter-reel" id="jitter-reel-t3" style="font-size: 24px;">0000</div>
                    <div style="font-size: 10px; color: var(--text-muted);">ms</div>
                </div>
            </div>
            <!-- Three schedule calculations -->
            <div style="display: flex; gap: 8px; justify-content: center; width: 100%;" id="sched-row-10">
                <div class="sched-calc" id="sched-calc-t1" style="flex: 1; font-size: 11px;">
                    12:00:04 + <span style="color:#4a9eff;">2.371s</span> = <span class="time-val">12:00:06.371</span>
                </div>
                <div class="sched-calc" id="sched-calc-t2" style="flex: 1; font-size: 11px;">
                    12:00:08 + <span style="color:#f39c12;">1.142s</span> = <span class="time-val">12:00:09.142</span>
                </div>
                <div class="sched-calc" id="sched-calc-t3" style="flex: 1; font-size: 11px;">
                    12:00:12 + <span style="color:#2ecc71;">2.817s</span> = <span class="time-val">12:00:14.817</span>
                </div>
            </div>
            <!-- Three INSERT cards -->
            <div class="insert-card" style="grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 4px;" id="insert-row-10">
                <div class="insert-panel" id="insert-t1">
                    <h4 style="color: #4a9eff;">INSERT T1 &rarr; event_slot</h4>
                    <div class="row-data">
                        <span class="field-name">event_id:</span> <span class="field-val">"pay-456"</span><br>
                        <span class="field-name">window:</span> <span class="field-val">12:00:04</span><br>
                        <span class="field-name">sched:</span> <span class="field-val">12:00:06.371</span>
                    </div>
                </div>
                <div class="insert-panel" id="insert-t2">
                    <h4 style="color: #f39c12;">INSERT T2 &rarr; event_slot</h4>
                    <div class="row-data">
                        <span class="field-name">event_id:</span> <span class="field-val">"pay-789"</span><br>
                        <span class="field-name">window:</span> <span class="field-val">12:00:08</span><br>
                        <span class="field-name">sched:</span> <span class="field-val">12:00:09.142</span>
                    </div>
                </div>
                <div class="insert-panel" id="insert-t3">
                    <h4 style="color: #2ecc71;">INSERT T3 &rarr; event_slot</h4>
                    <div class="row-data">
                        <span class="field-name">event_id:</span> <span class="field-val">"pay-012"</span><br>
                        <span class="field-name">window:</span> <span class="field-val">12:00:12</span><br>
                        <span class="field-name">sched:</span> <span class="field-val">12:00:14.817</span>
                    </div>
                </div>
            </div>
            <!-- Three UPDATE counter cards -->
            <div class="insert-card" style="grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 4px;" id="update-row-10">
                <div class="insert-panel" id="update-t1">
                    <h4 style="color: #4a9eff;">UPDATE counter T1</h4>
                    <div class="counter-display"><span class="counter-val" id="counter-val-t1">0</span><span style="font-size: 14px; color: var(--text-muted);"> / 100</span></div>
                </div>
                <div class="insert-panel" id="update-t2">
                    <h4 style="color: #f39c12;">UPDATE counter T2</h4>
                    <div class="counter-display"><span class="counter-val" id="counter-val-t2">0</span><span style="font-size: 14px; color: var(--text-muted);"> / 100</span></div>
                </div>
                <div class="insert-panel" id="update-t3">
                    <h4 style="color: #2ecc71;">UPDATE counter T3</h4>
                    <div class="counter-display"><span class="counter-val" id="counter-val-t3">0</span><span style="font-size: 14px; color: var(--text-muted);"> / 100</span></div>
                </div>
            </div>
        </div>
        <div class="db-tables-panel" id="db-tables-10"></div>
        <div class="step-controls" id="step-controls-10">
            <button class="step-btn" id="s10-prev" disabled>&#9664;</button>
            <span class="step-indicator" id="s10-indicator">Step 1 / 4</span>
            <button class="step-btn" id="s10-next">&#9654;</button>
        </div>
    </section>

    <!-- ===== SCENE 11: RESULTS ===== -->
    <section class="scene" id="scene-11">
        <div class="scene-title">Step 4: Interpret Results</div>
        <div class="scene-subtitle">Click a status card to see its response</div>
        <div class="results-container">
            <div class="result-paths">
                <div class="result-card result-new-card" id="result-new">
                    <h4 style="color: var(--success);">STATUS_NEW = 1</h4>
                    <div class="http-badge" style="background: rgba(46,204,113,0.15); color: var(--success);">200 OK</div>
                    <div class="result-desc">Slot freshly assigned.<br>Return AssignedSlot with<br>scheduledTime and delay.</div>
                </div>
                <div class="result-card result-existing-card" id="result-existing">
                    <h4 style="color: var(--primary);">STATUS_EXISTING = 0</h4>
                    <div class="http-badge" style="background: rgba(74,158,255,0.15); color: var(--primary);">200 OK</div>
                    <div class="result-desc">Idempotent hit.<br>Same event_id returns<br>same slot instantly.</div>
                </div>
                <div class="result-card result-exhausted-card" id="result-exhausted">
                    <h4 style="color: var(--error);">STATUS_EXHAUSTED = -1</h4>
                    <div class="http-badge" style="background: rgba(231,76,60,0.15); color: var(--error);">503</div>
                    <div class="result-desc">All windows exhausted<br>within search limit.<br>Throw exception.</div>
                </div>
            </div>
            <div class="glass-card response-json" id="response-json-11" style="opacity: 0; transition: opacity 0.3s;">
                <div class="resp-header" id="resp-header-11" style="color: var(--success);">Response (200 OK)</div>
                <div class="row-data" id="resp-body-11"></div>
                <div class="resp-note" id="resp-note-11" style="color: var(--text-muted);"></div>
            </div>
        </div>
    </section>


</div>

<!-- Navigation Controls -->
<nav id="controls">
    <button id="prev-btn" disabled>&larr; Previous</button>
    <div id="scene-dots"></div>
    <button id="next-btn">Next &rarr;</button>
</nav>

<!-- Global Step Controls (bottom-right, shown only on step-based scenes) -->
<div id="step-controls-global">
    <button class="step-btn" id="sg-prev" disabled>&#9664;</button>
    <span class="step-indicator" id="sg-indicator">Step 1 / 1</span>
    <button class="step-btn" id="sg-next">&#9654;</button>
</div>

<!-- Keyboard Hint -->
<div id="keyboard-hint">
    Use <kbd>&larr;</kbd> <kbd>&rarr;</kbd> arrow keys or click <kbd>Next</kbd> to navigate
</div>

<script>
(function() {
    'use strict';

    const TOTAL_SCENES = 11;
    let currentScene = 0;
    let animationTimeouts = [];

    // ===== DB STATE (shared across scenes 5, 7-10) =====
    const dbState = {
        windowCounter: [],  // [{windowStart, slotCount, status, cssClass}]
        eventSlot: [],      // [{eventId, windowStart, scheduledTime, cssClass}]
        trackWindowEnd: [], // [{requestedTime, windowEnd, cssClass}]
        label: '',
        sqlHint: '',
        esSqlHint: '',      // SQL hint displayed under event_slot table
        tweSqlHint: ''      // SQL hint displayed under track_window_end table
    };

    function renderDbTables(sceneNum) {
        const panel = document.getElementById('db-tables-' + sceneNum);
        if (!panel) return;

        let wcRows = '';
        if (dbState.windowCounter.length === 0) {
            wcRows = '<div class="empty-label">(no rows)</div>';
        } else {
            wcRows = '<table><tr><th>window_start</th><th>slot_count</th><th>status</th></tr>';
            dbState.windowCounter.forEach(r => {
                const statusColor = r.status === 'CLOSED' ? 'var(--error)' : 'var(--success)';
                wcRows += `<tr class="${r.cssClass || ''}"><td>${r.windowStart}</td><td>${r.slotCount}</td><td style="color:${statusColor}">${r.status || 'OPEN'}</td></tr>`;
            });
            wcRows += '</table>';
        }

        let esRows = '';
        if (dbState.eventSlot.length === 0) {
            esRows = '<div class="empty-label">(no rows)</div>';
        } else {
            esRows = '<table><tr><th>event_id</th><th>window_start</th><th>scheduled_time</th></tr>';
            dbState.eventSlot.forEach(r => {
                esRows += `<tr class="${r.cssClass || ''}"><td>${r.eventId}</td><td>${r.windowStart}</td><td>${r.scheduledTime}</td></tr>`;
            });
            esRows += '</table>';
        }

        let tweRows = '';
        if (dbState.trackWindowEnd.length === 0) {
            tweRows = '<div class="empty-label">(no rows)</div>';
        } else {
            tweRows = '<table><tr><th>requested_time</th><th>window_end</th></tr>';
            dbState.trackWindowEnd.forEach(r => {
                tweRows += `<tr class="${r.cssClass || ''}"><td>${r.requestedTime}</td><td>${r.windowEnd}</td></tr>`;
            });
            tweRows += '</table>';
        }

        const labelHtml = dbState.label ? `<div class="db-label">${dbState.label}</div>` : '';
        const sqlHintHtml = dbState.sqlHint ? `<div class="sql-hint">${dbState.sqlHint}</div>` : '';
        const esSqlHintHtml = dbState.esSqlHint ? `<div class="sql-hint">${dbState.esSqlHint}</div>` : '';
        const tweSqlHintHtml = dbState.tweSqlHint ? `<div class="sql-hint">${dbState.tweSqlHint}</div>` : '';

        panel.innerHTML = `
            ${labelHtml}
            <div class="db-mini-table">
                <div class="table-title">rate_limit_window_counter</div>
                ${wcRows}
                ${sqlHintHtml}
            </div>
            <div class="db-mini-table">
                <div class="table-title">track_window_end</div>
                ${tweRows}
                ${tweSqlHintHtml}
            </div>
            <div class="db-mini-table">
                <div class="table-title">rate_limit_event_slot</div>
                ${esRows}
                ${esSqlHintHtml}
            </div>
        `;
    }

    function resetDbState() {
        dbState.windowCounter = [];
        dbState.eventSlot = [];
        dbState.trackWindowEnd = [];
        dbState.label = '';
        dbState.sqlHint = '';
        dbState.esSqlHint = '';
        dbState.tweSqlHint = '';
    }

    // ===== NAVIGATION =====
    const progressFill = document.getElementById('progress-fill');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const dotsContainer = document.getElementById('scene-dots');
    const scenes = document.querySelectorAll('.scene');

    for (let i = 0; i < TOTAL_SCENES; i++) {
        const dot = document.createElement('div');
        dot.className = 'scene-dot' + (i === 0 ? ' active' : '');
        dot.addEventListener('click', () => goToScene(i));
        dotsContainer.appendChild(dot);
    }

    function updateUI() {
        progressFill.style.width = ((currentScene + 1) / TOTAL_SCENES * 100) + '%';
        prevBtn.disabled = currentScene === 0;
        nextBtn.disabled = currentScene === TOTAL_SCENES - 1;
        const dots = dotsContainer.children;
        for (let i = 0; i < dots.length; i++) {
            dots[i].className = 'scene-dot';
            if (i === currentScene) dots[i].classList.add('active');
            else if (i < currentScene) dots[i].classList.add('visited');
        }
    }

    function clearTimeouts() { animationTimeouts.forEach(t => clearTimeout(t)); animationTimeouts = []; }
    function schedule(fn, delay) { animationTimeouts.push(setTimeout(fn, delay)); }

    function goToScene(index) {
        if (index < 0 || index >= TOTAL_SCENES || index === currentScene) return;
        clearTimeouts();
        const exitScene = scenes[currentScene];
        sceneHandlers[currentScene].exit();
        exitScene.classList.remove('active');
        if (index > currentScene) exitScene.classList.add('exit-left');
        setTimeout(() => exitScene.classList.remove('exit-left'), 500);
        currentScene = index;
        scenes[currentScene].classList.add('active');
        updateUI();
        schedule(() => sceneHandlers[currentScene].enter(), 100);
    }

    prevBtn.addEventListener('click', () => goToScene(currentScene - 1));
    nextBtn.addEventListener('click', () => goToScene(currentScene + 1));
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); goToScene(currentScene + 1); }
        if (e.key === 'ArrowLeft') { e.preventDefault(); goToScene(currentScene - 1); }
    });

    // ===== ANIMATION UTILITIES =====
    function showElement(id, delay) {
        schedule(() => {
            const el = typeof id === 'string' ? document.getElementById(id) : id;
            if (el) el.classList.add('visible', 'show');
        }, delay);
    }
    function hideElement(id) {
        const el = typeof id === 'string' ? document.getElementById(id) : id;
        if (el) el.classList.remove('visible', 'show');
    }
    function resetScene(sceneId) {
        const scene = document.getElementById(sceneId);
        scene.querySelectorAll('.visible, .show, .drawn, .active-step, .active-result, .active-node, .bounce, .full, .flipping')
            .forEach(el => el.classList.remove('visible', 'show', 'drawn', 'active-step', 'active-result', 'active-node', 'bounce', 'full', 'flipping'));
    }
    function animateCounter(elementId, from, to, durationMs, delay) {
        schedule(() => {
            const el = document.getElementById(elementId);
            if (!el) return;
            const startTime = performance.now();
            function tick(now) {
                const progress = Math.min((now - startTime) / durationMs, 1);
                el.textContent = Math.round(from + (to - from) * progress);
                if (progress < 1) requestAnimationFrame(tick);
            }
            requestAnimationFrame(tick);
        }, delay);
    }

    // ===== STEP CONTROL HELPER =====
    const sgPrev = document.getElementById('sg-prev');
    const sgNext = document.getElementById('sg-next');
    const sgIndicator = document.getElementById('sg-indicator');
    const sgContainer = document.getElementById('step-controls-global');
    let sgHandler = null;

    sgPrev.addEventListener('click', () => { if (sgHandler) sgHandler.prev(); });
    sgNext.addEventListener('click', () => { if (sgHandler) sgHandler.next(); });

    function showGlobalControls(handler) {
        sgHandler = handler;
        sgContainer.classList.add('visible');
    }
    function hideGlobalControls() {
        sgHandler = null;
        sgContainer.classList.remove('visible');
    }

    function makeStepController(sceneNum, totalSteps, applyStepFn) {
        let step = 0;

        function updateBtns() {
            sgPrev.disabled = step === 0;
            sgNext.disabled = step === totalSteps - 1;
            sgIndicator.textContent = 'Step ' + (step + 1) + ' / ' + totalSteps;
        }

        function goTo(s) {
            step = Math.max(0, Math.min(totalSteps - 1, s));
            clearTimeouts();
            applyStepFn(step);
            updateBtns();
        }

        const handler = {
            prev() { goTo(step - 1); },
            next() { goTo(step + 1); }
        };

        return {
            enter() { showGlobalControls(handler); goTo(0); },
            reset() { step = 0; hideGlobalControls(); },
            goTo
        };
    }

    // ===== SCENE HANDLERS =====
    const sceneHandlers = {

        // Scene 1: Title
        0: {
            enter() {
                const items = scenes[0].querySelectorAll('.anim-item');
                items.forEach((el, i) => schedule(() => el.classList.add('show'), i * 200));
                scenes[0].querySelectorAll('.tech-badge').forEach((b, i) => {
                    schedule(() => { b.style.animation = `popIn 0.4s ease ${i * 0.15}s forwards`; }, 600);
                });
            },
            exit() {
                resetScene('scene-1');
                scenes[0].querySelectorAll('.tech-badge').forEach(b => { b.style.animation = ''; b.style.opacity = 0; });
            }
        },

        // Scene 2: Architecture
        1: {
            enter() {
                scenes[1].querySelectorAll('.anim-item').forEach((el, i) => schedule(() => el.classList.add('show'), i * 150));
                const order = ['arch-client', 'arrow-1', 'arch-api', 'arrow-2', 'arch-resource', 'arrow-3', 'arch-service', 'arrow-4', 'arch-config', 'arch-sql', 'arrow-5', 'arch-db'];
                let d = 400;
                order.forEach(id => {
                    const el = document.getElementById(id);
                    if (el.classList.contains('arch-arrow-line')) schedule(() => el.classList.add('drawn'), d);
                    else showElement(id, d);
                    d += 250;
                });
            },
            exit() {
                resetScene('scene-2');
                ['arrow-1','arrow-2','arrow-3','arrow-4','arrow-5'].forEach(id => { const el = document.getElementById(id); el.classList.remove('drawn'); el.style.height = '0'; });
            }
        },

        // Scene 3: Time Window Model
        2: {
            enter() {
                scenes[2].querySelectorAll('.anim-item').forEach((el, i) => schedule(() => el.classList.add('show'), i * 150));
                schedule(() => document.getElementById('timeline-axis-3').classList.add('drawn'), 300);
                const windowsRow = document.getElementById('windows-row-3');
                windowsRow.innerHTML = '';
                const times = ['12:00:00','12:00:04','12:00:08','12:00:12','12:00:16'];
                const fills = [85, 100, 42, 67, 15];
                times.forEach((time, wi) => {
                    const box = document.createElement('div');
                    box.className = 'window-box'; box.id = 'win-box-' + wi;
                    const cc = fills[wi] < 70 ? 'var(--success)' : fills[wi] < 100 ? 'var(--warning)' : 'var(--error)';
                    box.innerHTML = `<div class="window-label">${time}</div><div class="window-capacity"><span class="count" id="win-count-${wi}" style="color:${cc}">0</span> / 100</div><div class="slots-area" id="slots-area-${wi}"></div>`;
                    windowsRow.appendChild(box);
                    schedule(() => box.classList.add('visible'), 800 + wi * 200);
                    animateCounter('win-count-' + wi, 0, fills[wi], 1200, 1000 + wi * 200);
                    const sc = Math.min(fills[wi], 40);
                    for (let s = 0; s < sc; s++) {
                        const dot = document.createElement('div');
                        dot.className = 'slot-dot';
                        dot.style.left = (Math.random() * 90 + 2) + '%';
                        dot.style.top = (Math.random() * 80 + 5) + '%';
                        dot.style.background = wi === 1 ? 'var(--error)' : 'var(--primary)';
                        schedule(() => { const area = document.getElementById('slots-area-' + wi); if (area) { area.appendChild(dot); dot.classList.add('visible'); } }, 1200 + wi * 200 + s * 30);
                    }
                    if (fills[wi] >= 100) schedule(() => box.classList.add('full'), 2000 + wi * 200);
                });
                schedule(() => document.getElementById('jitter-label-3').classList.add('visible'), 3000);
            },
            exit() { resetScene('scene-3'); document.getElementById('timeline-axis-3').classList.remove('drawn'); document.getElementById('jitter-label-3').classList.remove('visible'); }
        },

        // Scene 4: 4-Step Overview
        3: {
            enter() {
                scenes[3].querySelectorAll('.anim-item').forEach((el, i) => schedule(() => el.classList.add('show'), i * 150));
                for (let i = 1; i <= 4; i++) {
                    showElement('step-' + i, 300 + (i - 1) * 300);
                    if (i < 4) showElement('conn-' + i, 300 + (i - 1) * 300 + 200);
                }
                schedule(() => document.getElementById('step-3').classList.add('active-step'), 1800);
            },
            exit() { resetScene('scene-4'); }
        },

        // Scene 5: Load Configuration (step controls + DB tables)
        4: (() => {
            function applyStep(step) {
                const narrative = document.getElementById('s5-narrative');
                const hitContainer = document.getElementById('path-hit-container');
                const missContainer = document.getElementById('path-miss-container');
                const configCard = document.getElementById('config-result-card');

                narrative.style.opacity = '0';
                hitContainer.style.opacity = '0';
                missContainer.style.opacity = '0';
                configCard.style.opacity = '0';

                if (step >= 0) {
                    narrative.style.opacity = '1';
                    hitContainer.style.opacity = '1';
                }
                if (step >= 1) {
                    missContainer.style.opacity = '1';
                }
                if (step >= 2) {
                    configCard.style.opacity = '1';
                }
            }
            const ctrl = makeStepController(5, 3, applyStep);
            return {
                enter() {
                    ctrl.enter();
                },
                exit() {
                    ['s5-narrative', 'path-hit-container', 'path-miss-container', 'config-result-card'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.style.opacity = '0';
                    });
                    resetScene('scene-5');
                    ctrl.reset();
                }
            };
        })(),

        // Scene 6: Compute Search Params (step controls, card per variable)
        5: (() => {
            const paramIds = ['param-1','param-2','param-3','param-4','param-5','param-6','param-7','param-8'];
            const descriptions = [
                'requestedTime: the timestamp from the incoming API call',
                'windowStart: snap to the nearest window boundary (floor alignment)',
                'elapsedMs: how far into the current window the request lands',
                'maxFirstWindow: proportional capacity for the partial first window',
                'firstJitterMs: constrained jitter so scheduledTime \u2265 requestedTime',
                'fullJitterMs: unconstrained jitter for subsequent full windows',
                'maxWindowsInChunk: how many windows to provision per chunk',
                'maxChunksToSearch: how many chunks to search before giving up. All 8 values are now ready for the transaction.'
            ];
            function applyStep(step) {
                paramIds.forEach((id, i) => {
                    const el = document.getElementById(id);
                    if (i <= step) el.classList.add('visible');
                    else el.classList.remove('visible');
                });
                document.getElementById('s6-desc').textContent = descriptions[step] || '';
            }
            const ctrl = makeStepController(6, 8, applyStep);
            return {
                enter() { ctrl.enter(); },
                exit() {
                    resetScene('scene-6');
                    paramIds.forEach(id => document.getElementById(id).classList.remove('visible'));
                    document.getElementById('s6-desc').textContent = '';
                    ctrl.reset();
                }
            };
        })(),

        // Scene 7: Idempotency Check (step controls + DB tables)
        6: (() => {
            function applyStep(step) {
                const fc = document.getElementById('idem-first-call');
                const sc = document.getElementById('idem-second-call');
                ['idem-s1','idem-s2','idem-s3','idem-s4','idem-s5','idem-s6'].forEach(id => document.getElementById(id).classList.remove('visible'));
                fc.classList.remove('visible');
                sc.classList.remove('visible');

                resetDbState();

                // Step 0: JDBC banner + functions bar
                dbState.label = 'Transaction begins \u2014 checkExistingSlot()';

                if (step >= 1) {
                    // First call: SELECT, NO_DATA_FOUND
                    fc.classList.add('visible');
                    ['idem-s1','idem-s2','idem-s3'].forEach(id => document.getElementById(id).classList.add('visible'));
                    dbState.label = 'SELECT from event_slot WHERE event_id = \'pay-456\'';
                    dbState.esSqlHint = 'SELECT ... WHERE event_id = \'pay-456\' \u2192 NO_DATA_FOUND';
                }
                if (step >= 2) {
                    // Second call scenario: row found (pre-existing from earlier assignment)
                    sc.classList.add('visible');
                    ['idem-s4','idem-s5'].forEach(id => document.getElementById(id).classList.add('visible'));
                    dbState.windowCounter = [
                        { windowStart: '12:00:04', slotCount: 1, status: 'OPEN', cssClass: '' }
                    ];
                    dbState.eventSlot = [
                        { eventId: 'pay-456', windowStart: '12:00:04', scheduledTime: '12:00:06.371', cssClass: 'row-highlight' }
                    ];
                    dbState.label = 'Second call: event_id found! Return existing slot.';
                    dbState.esSqlHint = 'SELECT ... WHERE event_id = \'pay-456\' \u2192 ROW FOUND';
                }
                if (step >= 3) {
                    document.getElementById('idem-s6').classList.add('visible');
                    dbState.eventSlot[0].cssClass = 'row-insert';
                    dbState.label = 'STATUS_EXISTING = 0 \u2014 same slot returned to caller instantly';
                    dbState.esSqlHint = '';
                }
                renderDbTables(7);
            }
            const ctrl = makeStepController(7, 4, applyStep);
            return {
                enter() {
                    ctrl.enter();
                },
                exit() {
                    resetScene('scene-7');
                    resetDbState();
                    ctrl.reset();
                }
            };
        })(),

        // Scene 8: Phase 1 â€” First Window (step controls + DB tables)
        7: (() => {
            function applyStep(step) {
                const sql = document.getElementById('skip-sql-8');
                const cases = ['skip-case-1', 'skip-case-2', 'skip-case-3'];
                const allSteps = ['skip-s1a','skip-s1b','skip-s2a','skip-s2b','skip-s2c','skip-s3a','skip-s3b'];
                const result = document.getElementById('skip-result-8');

                sql.classList.remove('visible');
                cases.forEach(id => { const el = document.getElementById(id); el.classList.remove('visible'); el.style.display = 'none'; });
                allSteps.forEach(id => document.getElementById(id).classList.remove('visible'));
                result.classList.remove('visible');

                resetDbState();

                // Step 0: Show SQL + initial state
                dbState.label = 'Phase 1: ensureWindowExists(alignedStart) + tryLockFirstWindow()';
                dbState.sqlHint = 'INSERT window_counter ... ON DUP catch; SELECT slot_count FOR UPDATE SKIP LOCKED';

                if (step >= 0) {
                    sql.classList.add('visible');
                }
                if (step >= 1) {
                    // ensureWindowExists
                    document.getElementById('skip-case-1').style.display = '';
                    document.getElementById('skip-case-1').classList.add('visible');
                    ['skip-s1a','skip-s1b'].forEach(id => document.getElementById(id).classList.add('visible'));
                    dbState.windowCounter = [
                        { windowStart: '12:00:00', slotCount: 0, status: 'OPEN', cssClass: 'row-insert' }
                    ];
                    dbState.label = 'ensureWindowExists: INSERT window_counter for 12:00:00 (catch DUP if exists)';
                    dbState.sqlHint = 'INSERT INTO window_counter(window_start, slot_count) VALUES(12:00:00, 0)';
                }
                if (step >= 2) {
                    // tryLockFirstWindow
                    document.getElementById('skip-case-2').style.display = '';
                    document.getElementById('skip-case-2').classList.add('visible');
                    ['skip-s2a','skip-s2b','skip-s2c'].forEach(id => document.getElementById(id).classList.add('visible'));
                    dbState.windowCounter = [
                        { windowStart: '12:00:00', slotCount: 42, status: 'OPEN', cssClass: 'row-locked' }
                    ];
                    dbState.label = 'tryLockFirstWindow: SELECT slot_count FOR UPDATE SKIP LOCKED. count(42) < maxFirstWindow(62) \u2192 has capacity!';
                    dbState.sqlHint = 'SELECT slot_count FROM window_counter WHERE window_start = 12:00:00 FOR UPDATE SKIP LOCKED';
                }
                if (step >= 3) {
                    // First window full or locked fallthrough
                    document.getElementById('skip-case-3').style.display = '';
                    document.getElementById('skip-case-3').classList.add('visible');
                    ['skip-s3a','skip-s3b'].forEach(id => document.getElementById(id).classList.add('visible'));
                    dbState.windowCounter = [
                        { windowStart: '12:00:00', slotCount: 62, status: 'OPEN', cssClass: 'row-full' }
                    ];
                    dbState.label = 'First window full (count \u2265 maxFirstWindow) or SKIP LOCKED returned no row \u2192 fall through to Phase 2.';
                    dbState.sqlHint = 'count(62) \u2265 maxFirstWindow(62) \u2192 full; proceed to findAndLockFirstAvailable()';
                }
                if (step >= 4) {
                    // Summary result
                    result.classList.add('visible');
                    dbState.windowCounter = [
                        { windowStart: '12:00:00', slotCount: 42, status: 'OPEN', cssClass: 'row-highlight' }
                    ];
                    dbState.label = 'In our example: first window has capacity \u2192 claimSlot with constrained jitter [elapsedMs, windowSizeMs).';
                    dbState.sqlHint = 'If capacity: claimSlot(); otherwise: findAndLockFirstAvailable()';
                }
                renderDbTables(8);
            }
            const ctrl = makeStepController(8, 5, applyStep);
            return {
                enter() { ctrl.enter(); },
                exit() {
                    resetScene('scene-8');
                    ['skip-case-1','skip-case-2','skip-case-3'].forEach(id => {
                        document.getElementById(id).style.display = 'none';
                    });
                    resetDbState();
                    ctrl.reset();
                }
            };
        })(),

        // Scene 9: Phase 2 â€” Frontier-Tracked Find+Lock (step controls + DB tables)
        8: (() => {
            // Compute center-X of a window box relative to the thread-anim-area
            function getWinX(idx) {
                const area = document.getElementById('thread-area-9');
                const win = document.getElementById('ww-' + idx);
                if (!area || !win) return 60;
                const areaRect = area.getBoundingClientRect();
                const winRect = win.getBoundingClientRect();
                return (winRect.left + winRect.width / 2) - areaRect.left - 13; // 13 = half thread circle width
            }

            function resetThreads() {
                const t1 = document.getElementById('t1'), t2 = document.getElementById('t2'), t3 = document.getElementById('t3');
                t1.style.transition = 'none'; t2.style.transition = 'none'; t3.style.transition = 'none';
                const startX = getWinX(0) + 'px';
                t1.style.left = startX; t1.style.top = '30px';
                t2.style.left = startX; t2.style.top = '30px';
                t3.style.left = startX; t3.style.top = '30px';
                t1.classList.remove('bounce'); t2.classList.remove('bounce'); t3.classList.remove('bounce');
                void t1.offsetWidth;
            }

            function resetLocks() {
                for (let i = 0; i < 4; i++) {
                    document.getElementById('lock-' + i).classList.remove('visible');
                    document.getElementById('lock-' + i).style.color = '';
                    document.getElementById('status-' + i).textContent = '';
                    document.getElementById('status-' + i).style.color = '';
                    document.getElementById('status-' + i).classList.remove('visible');
                }
                document.getElementById('sql-caption-9').classList.remove('visible');
                document.getElementById('nowait-label-9').classList.remove('visible');
            }

            function applyStep(step) {
                const t1 = document.getElementById('t1'), t2 = document.getElementById('t2'), t3 = document.getElementById('t3');
                resetLocks();

                // Step 0: Show windows + legend
                ['ww-0','ww-1','ww-2','ww-3'].forEach(id => document.getElementById(id).classList.add('visible'));

                resetDbState();
                dbState.windowCounter = [
                    { windowStart: '12:00:00', slotCount: 100, status: 'CLOSED', cssClass: 'row-full' }
                ];
                dbState.label = 'fetchWindowEnd(): SELECT MAX(window_end) FROM track_window_end \u2192 NULL (first request)';

                // Compute window center positions dynamically
                const w0 = getWinX(0), w1 = getWinX(1), w2 = getWinX(2), w3 = getWinX(3);

                if (step === 0) {
                    // Reset all threads to start position
                    resetThreads();
                }

                if (step >= 1) {
                    // Batch provisioning: ensureChunkProvisioned() + INSERT track_window_end
                    resetThreads();
                    dbState.windowCounter = [
                        { windowStart: '12:00:00', slotCount: 100, status: 'CLOSED', cssClass: 'row-full' },
                        { windowStart: '12:00:04', slotCount: 0, status: 'OPEN', cssClass: 'row-insert' },
                        { windowStart: '12:00:08', slotCount: 0, status: 'OPEN', cssClass: 'row-insert' },
                        { windowStart: '12:00:12', slotCount: 0, status: 'OPEN', cssClass: 'row-insert' }
                    ];
                    dbState.trackWindowEnd = [
                        { requestedTime: '12:00:00', windowEnd: '12:00:16', cssClass: 'row-insert' }
                    ];
                    dbState.label = 'initWindowEnd(): batch INSERT 3 window_counter rows + INSERT track_window_end frontier';
                    dbState.sqlHint = 'INSERT INTO window_counter VALUES (12:00:04,0),(12:00:08,0),(12:00:12,0)';
                    dbState.tweSqlHint = 'INSERT INTO track_window_end (12:00:00, 12:00:16)';
                }
                if (step >= 2) {
                    // All threads scan provisioned range with findAndLockFirstAvailable
                    dbState.trackWindowEnd = [{ requestedTime: '12:00:00', windowEnd: '12:00:16', cssClass: '' }];
                    dbState.tweSqlHint = '';
                    t1.style.transition = 'all 0.6s ease';
                    t2.style.transition = 'all 0.6s ease';
                    t3.style.transition = 'all 0.6s ease';
                    t1.style.left = w0 + 'px'; t1.style.top = '15px';
                    t2.style.left = (w0 - 18) + 'px'; t2.style.top = '42px';
                    t3.style.left = (w0 + 18) + 'px'; t3.style.top = '42px';
                    t1.classList.remove('bounce'); t2.classList.remove('bounce'); t3.classList.remove('bounce');
                    document.getElementById('lock-0').classList.add('visible');
                    document.getElementById('lock-0').style.color = 'var(--error)';
                    document.getElementById('status-0').textContent = 'FULL (skipped)';
                    document.getElementById('status-0').style.color = 'var(--error)';
                    document.getElementById('status-0').classList.add('visible');
                    document.getElementById('sql-caption-9').classList.add('visible');
                    dbState.windowCounter[1].cssClass = ''; dbState.windowCounter[2].cssClass = ''; dbState.windowCounter[3].cssClass = '';
                    dbState.label = 'findAndLockFirstAvailable: scans provisioned range. 12:00:00 is FULL (count=100) \u2014 SKIP LOCKED skips contended rows.';
                    dbState.sqlHint = 'SELECT window_start FROM window_counter WHERE slot_count < 100 FOR UPDATE SKIP LOCKED FETCH FIRST 1 ROW ONLY';
                }
                if (step >= 3) {
                    // T1 locks first available, T2/T3 get next available atomically
                    t1.style.transition = 'all 0.8s cubic-bezier(0.25, -0.3, 0.25, 1.3)';
                    t2.style.transition = 'all 0.8s cubic-bezier(0.25, -0.3, 0.25, 1.3)';
                    t3.style.transition = 'all 0.8s cubic-bezier(0.25, -0.3, 0.25, 1.3)';
                    t1.style.left = w1 + 'px'; t1.style.top = '15px';
                    t2.style.left = (w1 - 18) + 'px'; t2.style.top = '42px';
                    t3.style.left = (w1 + 18) + 'px'; t3.style.top = '42px';
                    document.getElementById('lock-1').classList.add('visible');
                    document.getElementById('lock-1').style.color = '#4a9eff';
                    document.getElementById('status-1').textContent = 'LOCKED by T1';
                    document.getElementById('status-1').style.color = '#4a9eff';
                    document.getElementById('status-1').classList.add('visible');
                    dbState.windowCounter = [
                        { windowStart: '12:00:00', slotCount: 100, status: 'CLOSED', cssClass: 'row-full' },
                        { windowStart: '12:00:04', slotCount: 0, status: 'OPEN', cssClass: 'row-locked' },
                        { windowStart: '12:00:08', slotCount: 0, status: 'OPEN', cssClass: '' },
                        { windowStart: '12:00:12', slotCount: 0, status: 'OPEN', cssClass: '' }
                    ];
                    dbState.label = 'T1 locks 12:00:04 (first available). T2/T3 see it as SKIP LOCKED \u2192 skipped atomically.';
                    dbState.sqlHint = 'SKIP LOCKED: T1 gets 12:00:04; T2/T3 skip to next available row';
                }
                if (step >= 4) {
                    t1.style.left = w1 + 'px'; t1.style.top = '25px';
                    t2.style.transition = 'all 0.8s cubic-bezier(0.25, -0.3, 0.25, 1.3)';
                    t3.style.transition = 'all 0.8s cubic-bezier(0.25, -0.3, 0.25, 1.3)';
                    t2.style.left = w2 + 'px'; t2.style.top = '15px';
                    t3.style.left = w2 + 'px'; t3.style.top = '42px';
                    document.getElementById('lock-2').classList.add('visible');
                    document.getElementById('lock-2').style.color = '#f39c12';
                    document.getElementById('status-2').textContent = 'LOCKED by T2';
                    document.getElementById('status-2').style.color = '#f39c12';
                    document.getElementById('status-2').classList.add('visible');
                    dbState.windowCounter = [
                        { windowStart: '12:00:00', slotCount: 100, status: 'CLOSED', cssClass: 'row-full' },
                        { windowStart: '12:00:04', slotCount: 0, status: 'OPEN', cssClass: 'row-locked' },
                        { windowStart: '12:00:08', slotCount: 0, status: 'OPEN', cssClass: 'row-locked' },
                        { windowStart: '12:00:12', slotCount: 0, status: 'OPEN', cssClass: '' }
                    ];
                    dbState.label = 'T2 locks 12:00:08. If no available window in chunk \u2192 extension loop: provision new chunk + INSERT track_window_end.';
                    dbState.sqlHint = 'Extension loop: ensureChunkProvisioned() then findAndLockFirstAvailable() in new range';
                }
                if (step >= 5) {
                    t1.style.left = w1 + 'px'; t1.style.top = '25px';
                    t2.style.left = w2 + 'px'; t2.style.top = '25px';
                    t3.style.transition = 'all 0.8s cubic-bezier(0.25, -0.3, 0.25, 1.3)';
                    t3.style.left = w3 + 'px'; t3.style.top = '25px';
                    document.getElementById('lock-3').classList.add('visible');
                    document.getElementById('lock-3').style.color = '#2ecc71';
                    document.getElementById('status-3').textContent = 'LOCKED by T3';
                    document.getElementById('status-3').style.color = '#2ecc71';
                    document.getElementById('status-3').classList.add('visible');
                    document.getElementById('nowait-label-9').classList.add('visible');
                    dbState.windowCounter = [
                        { windowStart: '12:00:00', slotCount: 100, status: 'CLOSED', cssClass: 'row-full' },
                        { windowStart: '12:00:04', slotCount: 0, status: 'OPEN', cssClass: 'row-pulse' },
                        { windowStart: '12:00:08', slotCount: 0, status: 'OPEN', cssClass: 'row-pulse' },
                        { windowStart: '12:00:12', slotCount: 0, status: 'OPEN', cssClass: 'row-pulse' }
                    ];
                    dbState.label = 'All threads locked their own windows! T1\u219212:00:04, T2\u219212:00:08, T3\u219212:00:12. Each proceeds to claimSlot().';
                    dbState.sqlHint = 'FOR UPDATE SKIP LOCKED \u2014 skip contended rows atomically!';
                }
                renderDbTables(9);
            }

            const ctrl = makeStepController(9, 6, applyStep);
            return {
                enter() {
                    ctrl.enter();
                },
                exit() {
                    resetScene('scene-9');
                    resetThreads();
                    resetLocks();
                    resetDbState();
                    ctrl.reset();
                }
            };
        })(),

        // Scene 10: Claim Slot with Jitter (step controls + DB tables) â€” 3 threads
        9: (() => {
            let reelIntervals = [];
            const reelIds = ['jitter-reel-t1', 'jitter-reel-t2', 'jitter-reel-t3'];
            const jitterBoxIds = ['jitter-box-t1', 'jitter-box-t2', 'jitter-box-t3'];
            const schedIds = ['sched-calc-t1', 'sched-calc-t2', 'sched-calc-t3'];
            const insertIds = ['insert-t1', 'insert-t2', 'insert-t3'];
            const updateIds = ['update-t1', 'update-t2', 'update-t3'];
            const counterIds = ['counter-val-t1', 'counter-val-t2', 'counter-val-t3'];
            const jitterValues = ['2371', '1142', '2817'];
            const jitterColors = ['#4a9eff', '#f39c12', '#2ecc71'];

            function clearReels() {
                reelIntervals.forEach(iv => clearInterval(iv));
                reelIntervals = [];
                reelIds.forEach(id => {
                    const reel = document.getElementById(id);
                    reel.textContent = '0000';
                    reel.style.color = '';
                });
            }

            function applyStep(step) {
                clearReels();
                const appNote = document.getElementById('app-server-note-10');
                appNote.style.opacity = '0';

                jitterBoxIds.forEach(id => document.getElementById(id).classList.remove('visible'));
                schedIds.forEach(id => document.getElementById(id).classList.remove('visible'));
                insertIds.forEach(id => document.getElementById(id).classList.remove('visible'));
                updateIds.forEach(id => document.getElementById(id).classList.remove('visible'));
                counterIds.forEach(id => {
                    const el = document.getElementById(id);
                    el.textContent = '0';
                    el.classList.remove('flipping');
                });
                document.getElementById('insert-row-10').style.opacity = '0';
                document.getElementById('update-row-10').style.opacity = '0';
                document.getElementById('sched-row-10').style.opacity = '0';
                document.getElementById('jitter-row-10').style.opacity = '0';

                // Carry over from scenes 8/9
                resetDbState();
                dbState.windowCounter = [
                    { windowStart: '12:00:00', slotCount: 100, status: 'CLOSED', cssClass: 'row-full' },
                    { windowStart: '12:00:04', slotCount: 0, status: 'OPEN', cssClass: 'row-locked' },
                    { windowStart: '12:00:08', slotCount: 0, status: 'OPEN', cssClass: 'row-locked' },
                    { windowStart: '12:00:12', slotCount: 0, status: 'OPEN', cssClass: 'row-locked' }
                ];
                dbState.trackWindowEnd = [
                    { requestedTime: '12:00:00', windowEnd: '12:00:16', cssClass: '' }
                ];
                dbState.label = 'claimSlot() \u2014 All 3 threads compute jitter in parallel on the app server';

                if (step >= 0) {
                    // Show app server note + 3 spinning jitter reels
                    appNote.style.opacity = '1';
                    document.getElementById('jitter-row-10').style.opacity = '1';
                    jitterBoxIds.forEach(id => document.getElementById(id).classList.add('visible'));
                    reelIds.forEach(id => {
                        const reel = document.getElementById(id);
                        reelIntervals.push(setInterval(() => {
                            reel.textContent = String(Math.floor(Math.random() * 4000)).padStart(4, '0');
                        }, 50));
                    });
                    dbState.sqlHint = 'Jitter pre-computed in Kotlin for each thread';
                }
                if (step >= 1) {
                    // All 3 reels land on their values + show schedule calculations
                    clearReels();
                    document.getElementById('jitter-row-10').style.opacity = '1';
                    jitterBoxIds.forEach(id => document.getElementById(id).classList.add('visible'));
                    reelIds.forEach((id, i) => {
                        const reel = document.getElementById(id);
                        reel.textContent = jitterValues[i];
                        reel.style.color = jitterColors[i];
                    });
                    document.getElementById('sched-row-10').style.opacity = '1';
                    schedIds.forEach(id => document.getElementById(id).classList.add('visible'));
                    dbState.label = 'All 3 jitters computed: T1=2371ms, T2=1142ms, T3=2817ms. scheduledTime = windowStart + jitter.';
                    dbState.sqlHint = 'scheduled_time := window_start + jitter/1000';
                }
                if (step >= 2) {
                    // Show all 3 INSERT cards
                    document.getElementById('insert-row-10').style.opacity = '1';
                    insertIds.forEach(id => document.getElementById(id).classList.add('visible'));
                    dbState.eventSlot = [
                        { eventId: 'pay-456', windowStart: '12:00:04', scheduledTime: '12:00:06.371', cssClass: 'row-insert' },
                        { eventId: 'pay-789', windowStart: '12:00:08', scheduledTime: '12:00:09.142', cssClass: 'row-insert' },
                        { eventId: 'pay-012', windowStart: '12:00:12', scheduledTime: '12:00:14.817', cssClass: 'row-insert' }
                    ];
                    dbState.label = 'All 3 threads INSERT into rate_limit_event_slot simultaneously.';
                    dbState.sqlHint = '';
                    dbState.esSqlHint = 'INSERT INTO rate_limit_event_slot (event_id, window_start, scheduled_time, config_id) VALUES ...';
                }
                if (step >= 3) {
                    // Show all 3 UPDATE counters flipping 0 -> 1
                    document.getElementById('update-row-10').style.opacity = '1';
                    updateIds.forEach(id => document.getElementById(id).classList.add('visible'));
                    counterIds.forEach(id => {
                        const el = document.getElementById(id);
                        el.classList.add('flipping');
                        setTimeout(() => {
                            el.textContent = '1';
                            setTimeout(() => el.classList.remove('flipping'), 200);
                        }, 200);
                    });
                    dbState.windowCounter = [
                        { windowStart: '12:00:00', slotCount: 100, status: 'CLOSED', cssClass: 'row-full' },
                        { windowStart: '12:00:04', slotCount: 1, status: 'OPEN', cssClass: 'row-update' },
                        { windowStart: '12:00:08', slotCount: 1, status: 'OPEN', cssClass: 'row-update' },
                        { windowStart: '12:00:12', slotCount: 1, status: 'OPEN', cssClass: 'row-update' }
                    ];
                    dbState.eventSlot = [
                        { eventId: 'pay-456', windowStart: '12:00:04', scheduledTime: '12:00:06.371', cssClass: '' },
                        { eventId: 'pay-789', windowStart: '12:00:08', scheduledTime: '12:00:09.142', cssClass: '' },
                        { eventId: 'pay-012', windowStart: '12:00:12', scheduledTime: '12:00:14.817', cssClass: '' }
                    ];
                    dbState.label = 'All 3 threads claimed! T1\u219212:00:06.371, T2\u219212:00:09.142, T3\u219212:00:14.817. STATUS_NEW = 1 for each.';
                    dbState.sqlHint = 'UPDATE slot_count + 1, status = CASE WHEN full THEN \'CLOSED\' ELSE \'OPEN\' END';
                    dbState.esSqlHint = '';
                }
                renderDbTables(10);
            }

            const ctrl = makeStepController(10, 4, applyStep);
            return {
                enter() {
                    ctrl.enter();
                },
                exit() {
                    clearReels();
                    resetScene('scene-10');
                    document.getElementById('app-server-note-10').style.opacity = '0';
                    jitterBoxIds.forEach(id => document.getElementById(id).classList.remove('visible'));
                    schedIds.forEach(id => document.getElementById(id).classList.remove('visible'));
                    counterIds.forEach(id => document.getElementById(id).textContent = '0');
                    resetDbState();
                    ctrl.reset();
                }
            };
        })(),

        // Scene 11: Results & Summary (clickable cards)
        10: (() => {
            const responses = {
                'new': {
                    header: 'Response (200 OK)',
                    headerColor: 'var(--success)',
                    body: `{<br>&nbsp;&nbsp;<span class="field-name">"eventId":</span> <span class="field-val">"pay-456"</span>,<br>&nbsp;&nbsp;<span class="field-name">"scheduledTime":</span> <span class="field-val">"12:00:06.371Z"</span>,<br>&nbsp;&nbsp;<span class="field-name">"delayMs":</span> <span class="field-val">2371</span><br>}`,
                    note: 'Slot assigned. Window counter updated, status set to CLOSED if full.',
                    noteColor: 'var(--success)'
                },
                'existing': {
                    header: 'Response (200 OK)',
                    headerColor: 'var(--primary)',
                    body: `{<br>&nbsp;&nbsp;<span class="field-name">"eventId":</span> <span class="field-val">"pay-456"</span>,<br>&nbsp;&nbsp;<span class="field-name">"scheduledTime":</span> <span class="field-val">"12:00:06.371Z"</span>,<br>&nbsp;&nbsp;<span class="field-name">"delayMs":</span> <span class="field-val">2371</span><br>}`,
                    note: 'Idempotent hit \u2014 same slot returned instantly, no DB write',
                    noteColor: 'var(--primary)'
                },
                'exhausted': {
                    header: 'Response (503 Service Unavailable)',
                    headerColor: 'var(--error)',
                    body: `{<br>&nbsp;&nbsp;<span class="field-name">"error":</span> <span class="field-val">"SlotAssignmentException"</span>,<br>&nbsp;&nbsp;<span class="field-name">"message":</span> <span class="field-val">"All windows exhausted within search limit"</span>,<br>&nbsp;&nbsp;<span class="field-name">"windowsSearched":</span> <span class="field-val">100</span><br>}`,
                    note: 'Caller should retry later or increase maxChunksToSearch config',
                    noteColor: 'var(--error)'
                }
            };

            function selectResult(type) {
                const cards = { new: 'result-new', existing: 'result-existing', exhausted: 'result-exhausted' };
                Object.keys(cards).forEach(k => {
                    document.getElementById(cards[k]).classList.remove('active-result');
                });
                document.getElementById(cards[type]).classList.add('active-result');

                const resp = responses[type];
                document.getElementById('resp-header-11').textContent = resp.header;
                document.getElementById('resp-header-11').style.color = resp.headerColor;
                document.getElementById('resp-body-11').innerHTML = resp.body;
                document.getElementById('resp-note-11').textContent = resp.note;
                document.getElementById('resp-note-11').style.color = resp.noteColor;
                document.getElementById('response-json-11').style.opacity = '1';
            }

            document.getElementById('result-new').addEventListener('click', () => selectResult('new'));
            document.getElementById('result-existing').addEventListener('click', () => selectResult('existing'));
            document.getElementById('result-exhausted').addEventListener('click', () => selectResult('exhausted'));

            return {
                enter() {
                    showElement('result-new', 400);
                    showElement('result-existing', 700);
                    showElement('result-exhausted', 1000);
                    schedule(() => selectResult('new'), 1400);
                },
                exit() {
                    resetScene('scene-11');
                    document.getElementById('response-json-11').style.opacity = '0';
                }
            };
        })()
    };

    // ===== INIT =====
    updateUI();
    setTimeout(() => sceneHandlers[0].enter(), 300);
})();
</script>

</body>
</html>
